<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	<script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
	<script type="text/javascript" src="js/jquery-timers.js"></script>
	<script type="text/javascript" src="js/webgl/prototype.js"></script>
	<script type="text/javascript" src="js/conditional_gaussian.js"></script>
	<script type="text/javascript" src="js/sylvester.js"></script>
	<link type="text/css" href="css/style.css?23" rel="stylesheet" />
	<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.16.custom.css" rel="stylesheet" />	
	<link type="text/css" href="innerStyle.css" rel="stylesheet" />	
	<script type="text/javascript" src="js/body_sliders.js?10"></script>
	<script src="three.js-master/build/three.js"></script>
	
	<script type="text/javascript" src="shapedata/female/all_female/chest.js"></script>
	<script type="text/javascript" src="shapedata/female/all_female/fitnes.js"></script>
	<script type="text/javascript" src="shapedata/female/all_female/hip.js"></script>
	<script type="text/javascript" src="shapedata/female/all_female/stature.js"></script>
	<script type="text/javascript" src="shapedata/female/all_female/waist.js"></script>
	<script type="text/javascript" src="shapedata/female/all_female/weight.js"></script>
	<script type="text/javascript" src="shapedata/female/all_female/inseam.js"></script>
	<script type="text/javascript" src="shapedata/female/all_female/povprecje.js"></script>
	
	<script src="three.js-master/examples/js/Detector.js"></script>
	<script src="three.js-master/examples/js/controls/OrbitControls.js"></script>
	<script src="three.js-master/examples/js/libs/stats.min.js"></script>
	<script src="three.js-master/examples/js/loaders/OBJLoader.js"></script>
	<script src="three.js-master/examples/js/ClothRemake.js"></script>
	<script src="three.js-master/examples/js/loaders/DDSLoader.js"></script>
	<script src="three.js-master/examples/js/loaders/MTLLoader.js"></script>

	<select id="selectShirt" onchange="skrijPrikazi()">
		<option id="0">/</option>
		<option id="1">shirt</option>
		<option id="2">dress</option>
		<option id="3"> turtle</option>
	</select>
	<select id="selectPants" onchange="skrijPrikaziPants()">
		<option id="0">/</option>
		<option id="1">short skirt</option>
		<option id="2">long skirt</option>
	</select>
	<button id="startButton" onclick="start(false)">Start cloth simulation</button>
	<select id="shirtMaterialSelection">
		<option id="sStiff">stiff shirt material</option>
		<option id="sSoft">soft shirt material</option>
	</select>
	<select id="pantsMaterialSelection">
		<option id="pStiff">stiff pants material</option>
		<option id="pSoft">soft pants material</option>
	</select>
	<form action="" id="sizeSelection">
	  <input type="radio" name="size" value="0"> Extra Small<br>
	  <input type="radio" name="size" value="1"> Small<br>
	  <input type="radio" name="size" value="2" checked="true"> Medium<br>
	  <input type="radio" name="size" value="3"> Large
	   <input type="radio" name="size" value="4"> Extra Large
	</form>
	<form action="" id="pantsSizeSelection">
	  <input type="radio" name="size" value="0"> Small<br>
	  <input type="radio" name="size" value="1" checked="true"> Medium<br>
	  <input type="radio" name="size" value="2"> Large
	</form>
	
	<form action="demo_form.asp">
  R: <input type="text" name="rcolor" id="rcolor" value="default"><br>
  G: <input type="text" name="gcolor" id="gcolor" value="default"><br>
   B: <input type="text" name="bcolor" id="bcolor" value="default"><br>
</form>
	


	<script>
			function skrijPrikazi(){
				var izbran = -1;
				var selection = document.getElementById("selectShirt").childNodes;
				selection.forEach(function(opcija){
				if(!opcija.selected){
					return;
				}
				izbran = parseInt(opcija.getAttribute("id"));		
			});
				if(izbran == 0){
					document.getElementById("sizeSelection").hide();
				}else{
					document.getElementById("sizeSelection").show();
				}
			}
			function skrijPrikaziPants(){
				var izbran = -1;
				var selection = document.getElementById("selectPants").childNodes;
				selection.forEach(function(opcija){
				if(!opcija.selected){
					return;
				}
				izbran = parseInt(opcija.getAttribute("id"));		
			});
				if(izbran == 0){
					document.getElementById("pantsSizeSelection").hide();
				}else{
					document.getElementById("pantsSizeSelection").show();
				}
			}
			function skrij(){
				document.getElementById("sizeSelection").hide();
				document.getElementById("pantsSizeSelection").hide();
				console.log("hmm");
			}

	
			var dostop = false;//ASDASD
			var renderer;
			var prvoRisanje = true;
			//TEMP VARIABLES
			var scaleFactors =[0.0,0.0,0.0,0.0,0.0,0.0,0.0];
			var measurement_sliders = null;
			//var measurement_slider_divs = null;
			//CAREFULL TOLE JE SAM ZA MALE!!
				var means = [ 7.564329e+02, 9.285578e+02, 1.023178e+03, 1.642320e+03, 3.997508e+00, 7.551578e+02, 4.012371e+00 ]; 

				var covariance =  [
					[ 8.974942e+03, 7.552090e+03, 6.483763e+03, 8.309763e+02, 1.881021e+01, 1.558322e+02, -9.556207e+00 ],
					[ 7.552090e+03, 8.392775e+03, 6.396354e+03, 7.149492e+02, 1.892354e+01, 3.602916e+01, -7.956077e+00 ],
					[ 6.483763e+03, 6.396354e+03, 7.615241e+03, 1.194057e+03, 1.890881e+01, 2.847339e+02, -1.766251e+01 ],
					[ 8.309763e+02, 7.149492e+02, 1.194057e+03, 4.746183e+03, 5.688103e+00, 2.841976e+03, 1.125533e+01 ],
					[ 1.881021e+01, 1.892354e+01, 1.890881e+01, 5.688103e+00, 5.485452e-02, 2.377624e+00, -1.012215e-02 ],
					[ 1.558322e+02, 3.602916e+01, 2.847339e+02, 2.841976e+03, 2.377624e+00, 2.142281e+03, 7.671730e+00 ],
					[ -9.556207e+00, -7.956077e+00, -1.766251e+01, 1.125533e+01, -1.012215e-02, 7.671730e+00, 9.684213e+00 ]
					]; 
			//END OF TEMP
			
			function cross(a,b) {
				return [a[1]*b[2] - a[2]*b[1], a[2]*b[0] - a[0]*b[2], a[0]*b[1] - a[1]*b[0]];
			}
			function add(a,b) {
				return [a[0]+b[0], a[1]+b[1], a[2]+b[2]];
			}
			function sub(a,b) {
				return [a[0]-b[0], a[1]-b[1], a[2]-b[2]];
			}
			
			function flatten_two_d_array(two_d_array) {
				if (! two_d_array.length) { return []; }
				
				var height = two_d_array.length;
				var width = two_d_array[0].length;
				var length = height*width;
				var one_d_array = new Array(length);
				var index = length;
				for (i = height; i; ) {
					--i;
					for (j =  width; j; ) {
						one_d_array[--index] = two_d_array[i][--j];
					}
				}
				return one_d_array;
			}
			
			function initArray1D(length, value){
				var one_d_array = new Array(length);
				for (var i = length; i; ) { one_d_array[--i] = value; }
				return one_d_array
			}
			//IMPORTANT MODELS
			var templateVerticesMale=new Float32Array(flatten_two_d_array(femalePovprecje));
			var templateIndicesMale=new Uint16Array(flatten_two_d_array(mean_faces));
			var offsetVerticesMale=[];
			
			
			//IZDELAVA NORMAL:
			offsetVerticesMaleStructured=[];
			offsetVerticesMaleStructured.push(femaleStature);
			offsetVerticesMaleStructured.push(femaleWeight);
			offsetVerticesMaleStructured.push(femaleChest);
			offsetVerticesMaleStructured.push(femaleWaist);
			offsetVerticesMaleStructured.push(femaleHip);
			offsetVerticesMaleStructured.push(femaleInseam);
			offsetVerticesMaleStructured.push(femaleFitness);
			
			for(var x = 0; x < 7;x++){
				offsetVerticesMale.push(new Float32Array(flatten_two_d_array(offsetVerticesMaleStructured[x])));
			}
			
			
			var tri = mean_faces;
			var vrt2tri = femalePovprecje.map(function () { return []} );
			for (var i = 0; i < mean_faces.length; i++) {
				var face=mean_faces[i];
				vrt2tri[face[0]].push(i); vrt2tri[face[1]].push(i); vrt2tri[face[2]].push(i); 
			}
			var tx = femalePovprecje;
			var scaled_normal=new Array(tri.length);
			var dscaled_normal=new Array(7);
			for(var oo=0; oo<7; ++oo) {
				dscaled_normal[oo]=new Array(tri.length);
			}
			for(var ii=0; ii < tri.length; ++ii) {
				var t=tri[ii];
				scaled_normal[ii]=cross(sub(tx[t[1]], tx[t[0]]), sub(tx[t[2]], tx[t[0]]));
		
				for(var oo=0; oo<offsetVerticesMaleStructured.length; ++oo) {
					var ox=offsetVerticesMaleStructured[oo];
					dscaled_normal[oo][ii]=add(cross(sub(tx[t[1]], tx[t[0]]), sub(sub(ox[t[2]],tx[t[2]]), sub(ox[t[0]],tx[t[0]]))), 
	                cross(sub(sub(ox[t[1]],tx[t[1]]), sub(ox[t[0]],tx[t[0]])), sub(tx[t[2]], tx[t[0]])));
				}
			}
			
			var template_normals = initArray1D(3*tx.length, 0.0);
			for(var i=0; i<tx.length; ++i) {
				var vertex_faces = vrt2tri[i];
				for (var j = 0; j < vertex_faces.length; j++) {
					template_normals[3*i] += scaled_normal[vertex_faces[j]][0];
					template_normals[3*i + 1] += scaled_normal[vertex_faces[j]][1];
					template_normals[3*i + 2] += scaled_normal[vertex_faces[j]][2];
				}
			}
			
			var dnormals = new Array(7);
			for(var oo=0; oo<7; ++oo) {
				dnormals[oo] = initArray1D(3*tx.length, 0.0);
				for(var i=0; i<tx.length; ++i) {
					var vertex_faces = vrt2tri[i];
					for (var j = 0; j < vertex_faces.length; j++) {
						dnormals[oo][3*i] += dscaled_normal[oo][vertex_faces[j]][0];
						dnormals[oo][3*i + 1] += dscaled_normal[oo][vertex_faces[j]][1];
						dnormals[oo][3*i + 2] += dscaled_normal[oo][vertex_faces[j]][2];
					}
				}
			}
			
			//KONEC IZDELAVE NORMAL
			var templateNormalsMale = new Float32Array(template_normals);
			var offsetNormalsMale = [];
			for(var y = 0; y < 7;y++){
				offsetNormalsMale.push(new Float32Array(dnormals[y]));
			}
			
			
			
			
			var names = ['Height', 'Weight', 'Chest', 'Waist', 'Hips', 'Inseam', 'Exercise'];
			var $J = jQuery.noConflict();
			var current_language = 'english';
			function addElementFromTemplate(parent_element, template_element, strings_to_replace, replacements) {
				template_html = replaceTextStrings($J(template_element).html(), strings_to_replace, replacements);
				$J(parent_element).append(template_html);
			}
			
			function isRegExp(obj) {  
				return Object.prototype.toString.call(obj) === '[object RegExp]';  
			};

			function replaceTextStrings(text, strings, replacements) {
				for (var i = 0; i < strings.length; i++) {
					if (isRegExp( strings[i] )) {
						text =  text.replace( strings[i], replacements[i]);
					} else {
						text =  text.replace(RegExp(strings[i], 'g'), replacements[i]);
					}
				}
				return text;
			}
			
			function setScalefactor(index, scalefactor){
				if(isNaN(scalefactor))
					return;
				scaleFactors[index] = scalefactor;

				
			}
			
				var show_instructions = function showInstructions(measurement_name) {
					var description_text = '<p>' + measurement_descriptions[current_language][measurement_name] + '</p>';
					if ((measurement_name != 'Age') && (measurement_name != 'Weight') && (measurement_name != 'Activity')) {
						description_text = description_text + '<p>' + measurement_descriptions[current_language]['general_advice'] + '</p>';
					}
					$J('#popup_content').html('<h3>' + measurement_name + '</h3>\n' + description_text);
					$J('#popup').show();
				}
				
			var measurement_descriptions = {}

			var english_measurement_descriptions = {
			'Height' :
			"Stand with the back of your head against the stadiometer&#39;s measuring stick. Keep your chin level, and do not tilt your head up or down. Move the measurement instrument to the top of your head, and note the measurement.",

			'Weight' :
			"Your weight, as measured by a standard bathroom scale.",

			'Age' :
			"Your current age in years.",

			'Chest' :
			"Measure the circumference of your chest at your nipple level. Hold the end of the measuring tape in the middle of your chest at your nipple level.\n\nEvenly wrap the measuring tape around your chest. Note the measurement at the point where the tape measure meets at the 0 mark.",

			'Waist' :
			"Measure the circumference of your waist at your preferred waistline. Your preferred waistline is where you typically wear the waist of your pants.\n\nAfter exhaling, hold the beginning of the measuring tape in front of your body in the middle of your waistline. Evenly wrap the measuring tape around your waist. Note the measurement at the point where the tape measure meets at the 0 mark.",

			'Hips' :
			"Measure the circumference of your hips at the level where your hips are widest.\n\nHold the beginning of the measuring tape in front of your body in the middle of your hip line. Evenly wrap the measuring tape around your hips. Note the measurement at the point where the tape measure meets at the 0 mark.",

			'Inseam' :
			"Measure your inseam from your crotch to the floor. Your crotch is the inner, uppermost point of leg.\n\nHold the beginning of the tape measure at your crotch. Make sure you are holding it at the 0 mark. Pull the tape measure down to the floor where your foot is situated. Note the measurement at the point where the tape measure meets at the 0 mark.",

			'Activity' :
			"Indicate your fitness level by specifying the hours per week you engage in structured physical activites",

			'general_advice' :
			"Note: When taking your measurements, relax your muscles and stand with weight equally distributed on both feet. Make sure that the measuring tape is kept at an even horizontal level around your body."
			}

			measurement_descriptions['english'] = english_measurement_descriptions;
			
				var units = 'english';
				var set_conversion_factor = function() {
					if (units == 'metric') {
						conversion_factor = { 'weight' : 1.0, 'height' : 1.0 };
					} else {
						conversion_factor = { 'weight' : 2.2, 'height' : 1.0/2.54 };
					}
				}
				set_conversion_factor();	
				
				var set_units = function(new_units) {
					if (units != new_units) { toggle_units(); }
				}
				
				var toggle_units = function() {
					var unit_divs = $J('.slider-units');
					if (units == 'metric') {
						units = 'english';
						for (var i = 0; i < unit_divs.length; i++) {
							var content = $J(unit_divs[i]).html();
							$J(unit_divs[i]).html(content.replace('kilograms', 'pounds').replace('centimeters', 'inches'));
						}
					} else {
						units = 'metric';
						for (var i = 0; i < unit_divs.length; i++) {
							var content = $J(unit_divs[i]).html();
							$J(unit_divs[i]).html(content.replace('pounds', 'kilograms').replace('inches', 'centimeters'));
						}
					}
					set_conversion_factor();
					for (var i = 0; i < measurement_sliders.length; i++) {
						var slider_value = measurement_sliders[i].slider( "value" );
						setSliderValueField(slider_value, measurement_value_fields[i], measurement_names[i]);
					}
				};
				
				//SLIDER HEEEEEELLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL
				
				var diff = 5;
	var update_in_progress = false;
	var updateMeasurementsAndModel = function(measurement_field_index, value, animate, callback) {
		if (! update_in_progress) {
			update_in_progress = true;
			old_scale_factors = scale_factors;
			scale_factors = Array(number_of_sliders);
			if (value == null) {
				conditional_multivariate_gaussian.uncondition_on_indices([measurement_field_index]);
				mark_slider_as_unfixed(measurement_field_index);
			} else {
				conditional_multivariate_gaussian.condition_on_indices([measurement_field_index], [value]);
				mark_slider_as_fixed(measurement_field_index);
			}
			for (var i = 0; i < number_of_sliders; i++) {
				var value = conditional_multivariate_gaussian.all_values[i];
				if (measurement_names[i] == 'weight') {
					var slider_value = Math.pow(value, 3);
				} else if (measurement_names[i] == 'exercise' ) {
					var slider_value = value;
				} else if (measurement_names[i] == 'age' ) {
					var slider_value = value;
				} else {
					var slider_value = value/10.0;
				}				
				measurement_sliders[i].slider( "value", slider_value );
				scale_factors[i] = (value - mu[i])/diff;
			}
			
			if (animate) {
				var number_of_increments = 8;
				var update_model_function = function(number_of_increments, start_values, end_values, callback) {
					return function(inc) {
						for (var i = 0; i < end_values.length; i++) {
							setScalefactor(i, start_values[i] + (inc/number_of_increments)*(end_values[i] - start_values[i]) );
							//console.log("startValues: "+start_values[i]+" inc: "+inc+" number_of_increments: "+number_of_increments+" end_values: "+end_values[i]);
						}
						//console.log("lets SEEEEEEE");
						//refreshModel();
						start(true);
						if ((inc == number_of_increments) && callback) { callback(); }
					}
				}(number_of_increments, old_scale_factors, scale_factors, callback);
				update_in_progress = false;
				$J(document).everyTime(30, update_model_function, number_of_increments);
			} else {
				for (var i = 0; i < number_of_sliders; i++) { setScalefactor(i, scale_factors[i]); }
				update_in_progress = false;
				//refreshModel();
				start(true);
			}
		}

		
				//	console.log(i + ' stops')
				//start(model_loader.current_model);
	}
	
	var reset_all_sliders_function = function(next_slider_to_reset) {
		return function() { return reset_all_sliders(next_slider_to_reset); }
	}
	
	function reset_all_sliders(next_slider_to_reset) {
		next_slider_to_reset = (next_slider_to_reset != undefined) ? next_slider_to_reset : (number_of_sliders - 1);
		if ((next_slider_to_reset < number_of_sliders) && (next_slider_to_reset >= 0)) {
			var callback = reset_all_sliders_function(next_slider_to_reset - 1);
			if (measurement_status[next_slider_to_reset] == 'fixed') {
				updateMeasurementsAndModel(next_slider_to_reset, null, true, callback);
			} else {
				callback();
			}
		}
		return false;
	}
	
	function mark_slider_as_fixed(slider_index) {
		measurement_status[slider_index] = 'fixed';
		measurement_value_fields[slider_index].addClass('fixed');
		measurement_sliders[slider_index].addClass('fixed');
		
		measurement_status_fields[slider_index].addClass('fixed');
		js_string = 'updateMeasurementsAndModel(' + slider_index + ', null, true); return false;'
		//console.log("plZZZ");
		link_html = (current_language == 'english') ? ('SET <a href="#" onClick="' + js_string + '">(click to reset)</a>') : ('SETZEN <a href="#" onClick="' + js_string + '">(zur\374cksetzen)</a>');
		measurement_status_fields[slider_index].html(link_html);
		update_reset_button();
	}
	function mark_slider_as_unfixed(slider_index) {
		//console.log("call me crazy");
		measurement_status[slider_index] = 'predicted';
		measurement_value_fields[slider_index].removeClass('fixed');
		measurement_sliders[slider_index].removeClass('fixed');
		
		measurement_status_fields[slider_index].removeClass('fixed');
		measurement_status_fields[slider_index].html((current_language == 'english') ? 'PREDICTED' : 'ERWARTET');
		update_reset_button();
	}
	
	function update_reset_button() {
		fixed_slider_count = 0;
		for (var i = 0; i < number_of_sliders; i++) {
			if (measurement_status[i] == 'fixed') { fixed_slider_count++; }
		}
		if (fixed_slider_count) { $J('#reset_button').show(); }
		else { $J('#reset_button').hide(); }
	}
	
	function setSliderValueField(slider_value, measurement_value_field, measurement_field_name) {
		if (measurement_field_name == 'weight') {
			measurement_value_field.text( Math.round(conversion_factor['weight']*slider_value) );
		} else if (measurement_field_name == 'exercise' ) {
			measurement_value_field.text( Math.round( slider_value/3.0 ) );
		} else if (measurement_field_name == 'age' ) {
			measurement_value_field.text( Math.round( slider_value ) );
		} else {
			measurement_value_field.text( Math.round(conversion_factor['height']*slider_value) );
		}
	}
	
	function sliderUpdateFunction(measurement_slider, measurement_value_field, measurement_field_name, measurement_field_index, animate) {
		return function() {
			if (! animate) { slide_counters[measurement_field_index] += 1; }
			var slider_value = measurement_slider.slider( "value" );
			setSliderValueField(slider_value, measurement_value_field, measurement_field_name);
			cached_slider_values[measurement_field_index] = slider_value;
			if(dostop){
			//if (model_loader.current_model) {
				if (measurement_field_name == 'weight') {
					var value = Math.pow(slider_value, 1/3);
				} else if (measurement_field_name == 'exercise' ) {
					var value = slider_value;
				} else if (measurement_field_name == 'age' ) {
					var value = slider_value;
				} else {
					var value = 10*slider_value;
				}
//				console.log(slide_counters)
				if (slide_counters[measurement_field_index] > 3) {
					if (animate) { slide_counters[measurement_field_index] = 0; }
					updateMeasurementsAndModel(measurement_field_index, value, false);
				} else {
					if (animate) { slide_counters[measurement_field_index] = 0; }
					updateMeasurementsAndModel(measurement_field_index, value, animate);
				}
			//}
			}
		}
	}
	
	function sliderStartsFunction(i) {
		return function() {
			//console.log(i + ' starts')
			slide_counters[i] = 0;
		}
	}
	
	function sliderStopsFunction(i) {
		return function() {
			//console.log(i + ' stops')

		}
	}

	var ordering_of_data = [ 'waist', 'chest', 'hips', 'height', 'weight', 'inseam', 'exercise' ];
//	var ordering_of_data = [ 'waist', 'chest', 'hips', 'height', 'weight', 'inseam', 'age' ];
	
//	var min_values = { 'height': 110, 'weight': 30, 'age': 18, 'waist' : 50, 'inseam' : 50, 'chest' : 60, 'hips' : 60, 'exercise': 0 };
//	var max_values = { 'height': 220, 'weight': 250, 'age': 90, 'waist' : 200, 'inseam' : 140, 'chest' : 200, 'hips' : 220, 'exercise': 10 };
//	var initial_values = { 'height' : 164, 'weight': 65, 'age': 40, 'waist' : 77, 'inseam' : 75, 'chest' : 94, 'hips' : 103, 'exercise': 4 };

	var min_values = {};
	var max_values = {};
	var initial_values = {};
	var stds = {};
	var order_by_measurement = {};	
	for (var i = 0; i < ordering_of_data.length; i++) { order_by_measurement[ordering_of_data[i]] = i; }
	var measurement_slider_divs = null;	
	var number_of_sliders = null;
	//var measurement_sliders = null;
	var measurement_names = null;
	var measurement_value_fields = null;
	var measurement_status_fields = null;
	var measurement_status = null;
	var cached_slider_values = null;
	var fixed_slider_count = 0;
	var slide_counters = null;
	
	var mu = null;
	var sigma = null;
	var conditional_multivariate_gaussian = null;
	
	function setupSliders() {
		for (var i = 0; i < ordering_of_data.length; i++) {
			order_by_measurement[ordering_of_data[i]] = i;
			initial_values[ordering_of_data[i]] = means[i]/10.0;
			stds[ordering_of_data[i]] = Math.sqrt(covariance[i][i])/10.0;
		}
		initial_values['age'] = 10*initial_values['age'];
		initial_values['exercise'] = 10*initial_values['exercise'];
		initial_values['weight'] = 10*initial_values['weight'];
		stds['age'] = 10*stds['age'];
		stds['exercise'] = 10*stds['exercise'];
		stds['weight'] = 10*stds['weight'];
    
		for (var i = 0; i < ordering_of_data.length; i++) {
			min_values[ordering_of_data[i]] = Math.round(initial_values[ordering_of_data[i]] - 4*stds[ordering_of_data[i]]);
			min_values[ordering_of_data[i]] = Math.max(min_values[ordering_of_data[i]], 0)
			max_values[ordering_of_data[i]] = Math.round(initial_values[ordering_of_data[i]] + 5*stds[ordering_of_data[i]]);
		}
    
		initial_values['weight'] = Math.pow(initial_values['weight'], 3);
		//min_values['weight'] = Math.pow(min_values['weight'], 3);
		min_values['weight'] = 40;
		//max_values['weight'] = Math.pow(max_values['weight'], 3);
		max_values['weight'] = Math.pow(max_values['weight'], 3);
		max_values['chest'] = 130;
		max_values['exercise'] = 60;
		number_of_sliders = measurement_slider_divs.length;
		measurement_sliders = Array(number_of_sliders)
		measurement_value_fields = Array(number_of_sliders);
		measurement_names = Array(number_of_sliders);
		measurement_value_fields = Array(number_of_sliders);
		measurement_status_fields = Array(number_of_sliders);
		measurement_status = Array(number_of_sliders);
		cached_slider_values = Array(number_of_sliders);
		scale_factors = Array(number_of_sliders);
		slide_counters = Array(number_of_sliders);
		
		mu = Array(number_of_sliders);
		sigma = Array(number_of_sliders);
		var unconditioned_indices = Array(number_of_sliders);
		var conditioned_indices = [];
		var conditioned_values = [];
		
		for (var i = 0; i < number_of_sliders; i++) {
			var measurement_name = measurement_slider_divs[i].id.replace('-measurement-slider','');
			var measurement_slider = $J(measurement_slider_divs[i])
			var measurement_value_field = $J('#' + measurement_name + '-slider-value');
			var measurement_status_field = $J('#' + measurement_name + '-slider-status');
			measurement_names[i] = measurement_name;
			measurement_sliders[i] = measurement_slider;
			measurement_value_fields[i] = measurement_value_field;
			measurement_status_fields[i] = measurement_status_field;
			measurement_slider.slider({
				orientation: "horizontal",
				range: "min",
				min: min_values[measurement_name],
				max: max_values[measurement_name],
				value: initial_values[measurement_name],
				start: sliderStartsFunction(i),
				stop: sliderStopsFunction(i),
				slide: sliderUpdateFunction(measurement_slider, measurement_value_field, measurement_name, i, false),
				change: sliderUpdateFunction(measurement_slider, measurement_value_field, measurement_name, i, true),
				animate: 300,
				disabled: true
			});
			data_index = order_by_measurement[measurement_name];
			mu[i] = means[data_index];
			unconditioned_indices[i] = i;
			sigma[i] = Array(number_of_sliders);
		}
		for (var i = 0; i < number_of_sliders; i++) {
			var row_data_index = order_by_measurement[measurement_names[i]];
			for (var j = 0; j < number_of_sliders; j++) {
				var column_data_index = order_by_measurement[measurement_names[j]];
				sigma[i][j] = covariance[row_data_index][column_data_index];
			}
			
		}
		conditional_multivariate_gaussian = new ConditionalMultivariateGaussian(mu, sigma, unconditioned_indices, conditioned_indices, conditioned_values);
		for (var i = 0; i < number_of_sliders; i++) {
			mark_slider_as_unfixed(i);
			measurement_sliders[i].slider( "value", initial_values[measurement_names[i]] );
			cached_slider_values[i] = initial_values[measurement_names[i]];
			scale_factors[i] = 0;

		}
		fixed_slider_count = 0;
		dostop = true;

	}
	
				var mouseX = 0, mouseY = 0;

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;
			var mouseDown = false;
			var clothWorldMaths=[];
			var clothWorldMathsInverses=[];
			var clothGeometry = null;
			var clothGeometry2 = null;
			var oblacilo1 = null;
			var oblacilo2 = null;
			
			var boxesList=[];
			var boxesPoints=[];
			var boxesNormals=[];
			var sirinaSkatelj = 0;
			var stevecLUL = 0;
			var prejsniStevec = 1;
			scene = null;
			scene2 = null;
			var rend = null;
			geometry = null;
			positions = null;
			normals = null;
			indices = null;
			sf = null;
			mesh = null;
			camera  = null;
	function start(eventHandler){
	console.log("--------------");
	console.log(measurement_sliders[0].slider( "value"));
	console.log(measurement_sliders[5].slider( "value"));
	console.log(scaleFactors);
	//console.log(scaleFactors);
			if(frameCount != 0){
				frameCount = 0;
			}
			if(clothWorldMaths.length != 0){
				clothWorldMaths = [];
			}
			if(clothWorldMathsInverses.length != 0){
				clothWorldMathsInverses = [];
			}
			if(clothGeometry != null){
				clothGeometry = null;
			}
			if(clothGeometry2 != null){
				clothGeometry2 = null;
			}
			if(cloth != null){
				cloth = null;
			}
			if(cloth2 != null){
				cloth2 = null;
			}
			if(oblacilo1 != null){
				oblacilo1 = null;
			}
			if(oblacilo2 != null){
				oblacilo2 = null;
			}
			if(camera != null){
				//var c1 = 
				delete camera;
				//console.log(c1);
			}
			if(positions != null){
				//var a = 
				delete positions;
				//console.log(a);
			}
			if(normals != null){
				//var b =
				delete normals;
				//console.log(b);
			}
			if(indices != null){
				//var c =
				delete indices;
				//console.log(c);
			}
			if(sf != null){
				//var d =
				delete sf;
				//console.log(d);
			}
			if(geometry != null){
							//var d1 = 
							delete geometry.getAttribute('position').array;
				//var d2 = 
				delete geometry.getAttribute('normal').array;
				//var d3 = 
				delete geometry.getAttribute('position');
				//var d4 = 
				delete geometry.getIndex().array;
				//var d6 = 
				delete geometry.boundingBox;
				//console.log(d1);
				//console.log(d2);
				//console.log(d3);
				//console.log(d4);
				//console.log(d6);
				//var d5 = 
				delete geometry;
				//console.log(d5);
			}
			if(mesh != null){
				//var m1 = 
				delete mesh;
				//console.log(m1);
			}
			stevecLUL++;
			//console.log(stevecLUL);
			if(scene != null)
				delete scene;
			if(scene2 != null)
				scene2 = null;
			scene = new THREE.Scene();
			var sele = document.getElementById("selectShirt").childNodes;
			var sele2 = document.getElementById("selectPants").childNodes;
			var loadingIndex1=-1;
			var loadingIndex2=-1;
			sele.forEach(function(opcija){
				if(!opcija.selected){
					return;
				}
				loadingIndex1 = parseInt(opcija.getAttribute("id"));		
			});
			sele2.forEach(function(opcija){
				if(!opcija.selected){
					return;
				}
				loadingIndex2 = parseInt(opcija.getAttribute("id"));		
			});
					

			var clothPaint = true;
			if(loadingIndex1 < 1 && loadingIndex2 < 1){
				clothPaint = false;
				if(boxesList.length != 0){
					boxesList = [];
				}
				if(boxesPoints.length != 0){
					boxesPoints = [];
				}
				if(boxesNormals.length != 0){
					boxesNormals = [];
				}
			}
			if(eventHandler){
				clothPaint = false;
			}
			if(clothPaint){
				document.getElementById("sliderTry").hide();
				document.getElementById("startButton").innerHTML="Restart simulation";
			}else{
				document.getElementById("sliderTry").show();
				document.getElementById("startButton").innerHTML="Start cloth simulation";
			}
			if(clothPaint){
		//		if(!loaded){
					loadCloth(loadingIndex1,loadingIndex2);
				
					setTimeout(function(){
				//		if(loadingIndex2 < 1){
							setUpClothSimulation();
					//	}else{
					//		clothPaint = false;
				//		}
						init(clothPaint);
						animate();
					}, 1000);
	/*			}
				else{
					
					scene.add( oblacilo1 );
					setUpClothSimulation();
					init(clothPaint);
					animate();
				}*/
			}
			else{
				//scene.add( oblacilo1 );
				//setUpClothSimulation();
				init(clothPaint);
				//stevecLUL=prejsniStevec;
			//	console.log("-------");
			//	console.log(stevecLUL);
			//	console.log(prejsniStevec);
				animate();
			}
			function loadCloth(clothIndex,clothIndex2){
				if(clothIndex > 0){
					firstGravityChange = false;
					firstGravityChange2 = false;
					shirtMaterial = -1;
					pushingKoeficient = 0.1;
					
					if(document.getElementById("sStiff").selected){
						shirtStiffness = 1;
					}else{
						shirtStiffness = 2;
					}
					console.log(shirtStiffness);
					var velikost = -1;
					var sizeChoices = document.getElementById("sizeSelection").childNodes;
					sizeChoices.forEach(function(opcija){
						if(!opcija.checked){
							return;
						}
						velikost = parseInt(opcija.getAttribute("value"));		
					});
				
					scene2 = new THREE.Scene();
					var tex = new THREE.Texture();
					var arrayPathov = ['three.js-master/examples/obj/clothes/female/shirt3/',"three.js-master/examples/obj/clothes/female/","three.js-master/examples/obj/clothes/female/turtle/","three.js-master/examples/obj/clothes/female/"];
					var arrayOfNames=["attempt13","TeeUnrigged2","turtle5","TeeUnrigged"];
					if(clothIndex == 2){
						GRAVITY1 = 981 * 0.14;
						gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
					}else{
						GRAVITY1 = 981 * 0.014;
						gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
					}
				//	console.log(frameCountLimit);
					THREE.Loader.Handlers.add( /\.dds$/i, new THREE.DDSLoader() );

					var mtlLoader = new THREE.MTLLoader();
					mtlLoader.setPath(arrayPathov[clothIndex-1]);
					mtlLoader.load(arrayOfNames[clothIndex-1]+".mtl", function( materials ) {

						materials.preload();

						var objLoader = new THREE.OBJLoader();
						objLoader.setMaterials( materials );
						objLoader.setPath(arrayPathov[clothIndex-1]);
						objLoader.load(arrayOfNames[clothIndex-1]+".obj", function ( object ) {
						console.log(materials.materials);
						//	object.position.set(0,-20,-5.5);// turtle
						//	object.scale.set(0.7,0.68,0.7);
						//	object.position.set(0,-77,-5);// jacket
						//	object.scale.set(9,7,10.5);
						//	object.position.set(0,-92,-4);//dress
						//	object.scale.set(75,75,75); //dress
						//	object.position.set(0,-105,-3);//sleep
						//	object.scale.set(33,33,33);
						var r = parseInt(document.getElementById("rcolor").value) /255.0;
						console.log(r);
						var g = parseInt(document.getElementById("gcolor").value)/255.0;
						var b = parseInt(document.getElementById("bcolor").value)/255.0;
						var colorSet = false;
						if(!isNaN(r) && !isNaN(g) && !isNaN(b)){
							if(r >= 0  && r <= 1 && g >= 0 && g <= 1 && b >= 0 && b <= 1){
								colorSet = true
							}
						}
						console.log(colorSet);
						switch(clothIndex){
							case 1:	 
									if(colorSet){
										materials.materials["Material_#35"].color.r=r;
										materials.materials["Material_#35"].color.g=g;
										materials.materials["Material_#35"].color.b=b;
										materials.materials.textile_2.color.r=r;
										materials.materials.textile_2.color.g=g;
										materials.materials.textile_2.color.b=b;
									}else{
										materials.materials.textile_2.color.r=materials.materials["Material_#35"].color.r;
										materials.materials.textile_2.color.g=materials.materials["Material_#35"].color.g;
										materials.materials.textile_2.color.b=materials.materials["Material_#35"].color.b;
									}
									var vsotaVisin = measurement_sliders[0].slider( "value")+measurement_sliders[5].slider( "value");
									var vsotaOblin = measurement_sliders[1].slider( "value")+measurement_sliders[2].slider( "value")+measurement_sliders[3].slider( "value")+measurement_sliders[4].slider( "value");
									var odstotek = vsotaVisin/vsotaOblin;
									console.log(odstotek);
									frameCountLimit=200;
									GRAVITY1 = 981 * 0.0014;
									gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );			
									switch(velikost){
										case 0: 
											//	pushingKoeficient = 0.2;
												//object.position.set(0,-19,-3.5); 0 0
												//object.position.set(0,-12,-3.5); 1 0
												//object.position.set(0,22,-3.5);
												if(shirtStiffness == 2){
													shirtMaterial = 5;
												}
												var why = -19;
												var diffEnota = 7.0/42.0;
												var inseamValue =  measurement_sliders[5].slider( "value");
												why+=(inseamValue-57)*diffEnota;
												var diffEnota2 = 34/62.0;
												var hightValue = measurement_sliders[0].slider( "value");
												why+=(hightValue-137)*diffEnota2;
												object.position.set(0,why,-3.5);
												object.scale.set(15,15,15);
												object.rotateX(-1.5707963);
												object.rotateZ(0.1);
												firstGravityChange = true;
												frameCountLimit = 200;
												break;
										case 1: 
												var why = -23;
												var diffEnota = 6.0/42.0;
												var inseamValue =  measurement_sliders[5].slider( "value");
												why+=(inseamValue-57)*diffEnota;
												var diffEnota2 = 35/62.0;
												var hightValue = measurement_sliders[0].slider( "value");
												why+=(hightValue-137)*diffEnota2;
												//0 ins 0 h
												//object.position.set(0,-23,-3.5);
												//max ins 0 h
												//object.position.set(0,-17,-3.5);
												//max ins max h
												object.position.set(0,why,-3.5);
												object.scale.set(17.5,17.5,17.5);
												object.rotateX(-1.5707963);
												object.rotateZ(0.1);
												frameCountLimit = 200;
												if(odstotek < 1){
														GRAVITY1 = 981 * 0.014*8;
													gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
												}
												//GRAVITY1 = 981 * 0.014*8;
												//gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
										
										
												break;
										case 2:
												if(odstotek < 1){
													GRAVITY1 = 981 * 0.014*8;
													gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
												}
												if(shirtStiffness == 2){
													shirtMaterial = 6;
												}
												pushingKoeficient = 0.2;
												//object.position.set(0,-13,-3.5);
												//max ins max high
												//object.position.set(0,12,-3.5);
												//0 ins 0 high
												//object.position.set(0,-28,-3.5);
												//max ins 0 high
												//object.position.set(0,-22,-3.5);
												var why = -28;
												var diffEnota = 6.0/42.0;
												var inseamValue =  measurement_sliders[5].slider( "value");
												why+=(inseamValue-57)*diffEnota;
												var diffEnota2 = 34/62.0;
												var hightValue = measurement_sliders[0].slider( "value");
												why+=(hightValue-137)*diffEnota2;
												object.position.set(0,why,-3.5);
												object.scale.set(20,20,20);
												if(shirtStiffness == 1){
													shirtMaterial = 8;
												}
												object.rotateX(-1.5707963);
												object.rotateZ(0.1);
									//material=2;
									//material=2;*/
								//	object.position.set(-1,-21,-3); medium
								//	object.scale.set(8,8,8);
								//	beltHight = 5;
								//	beltNormalMatching=0;
								//	shirtBeltSimulationException = true;
										
												break;
										case 3: if(odstotek < 1){
														GRAVITY1 = 981 * 0.14/3;
													gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
												}
										//		if(stiffness == 2){
										//			shirtMaterial = 6;
										//		}
										//		pushingKoeficient = 0.2;
												//object.position.set(0,-13,-3.5);
												//max ins max high
												//object.position.set(0,12,-3.5);
												//0 ins 0 high
												//object.position.set(0,-28,-3.5);
												//max ins 0 high
												//object.position.set(0,-22,-3.5);
												var why = -34;
												var diffEnota = 8.0/42.0;
												var inseamValue =  measurement_sliders[5].slider( "value");
												why+=(inseamValue-57)*diffEnota;
												var diffEnota2 = 33/62.0;
												var hightValue = measurement_sliders[0].slider( "value");
												why+=(hightValue-137)*diffEnota2;
											//	object.position.set(0,-34,-3.5);// 0 0
												//object.position.set(0,-26,-3.5); //1 0
												//object.position.set(0,7,-3.5); // 1 1
												object.position.set(0,why,-3.5);
												object.scale.set(22.5,25,22.5);
										//		if(stiffness == 1){
										//			shirtMaterial = 8;
										//		}
												object.rotateX(-1.5707963);
												object.rotateZ(0.1);
										
												break;
										case 4: //pushingKoeficient = 0.2;
												//var why = -19;
												//var diffEnota = 7.0/42.0;
												//var inseamValue =  measurement_sliders[5].slider( "value");
												//why+=(inseamValue-57)*diffEnota;
												//var diffEnota2 = 34/62.0;
												//var hightValue = measurement_sliders[0].slider( "value");
												//why+=(hightValue-137)*diffEnota2;
											//	object.position.set(0,2,-3.5);// max max
										//		object.scale.set(31,20,35);
										//		object.position.set(0,0,-3.5);
												//	object.position.set(0,-37,-3.5); //0 0
											//	object.position.set(0,-31,-3.5);// max 0
												if(odstotek < 0.65){
													GRAVITY1 = 981 * 0.14/3;
													gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
												}
												var why = -37;
												var diffEnota = 6.0/42.0;
												var inseamValue =  measurement_sliders[5].slider( "value");
												why+=(inseamValue-57)*diffEnota;
												var diffEnota2 = 33/62.0;
												var hightValue = measurement_sliders[0].slider( "value");
												why+=(hightValue-137)*diffEnota2;
												object.position.set(0,why,-3.5);// max 0
										//	object.position.set(0,-35,-3.5);
												object.scale.set(25,35,25);
												object.rotateX(-1.5707963);
												object.rotateZ(0.1);
											//	pushingKoeficient = 0.05;
											//	firstGravityChange = true;
												frameCountLimit = 99;
												if(shirtStiffness == 1){
													shirtMaterial = 12;
												}
												if(shirtStiffness == 2){
													shirtMaterial =7;
												}
										
												break;
										default:
									}
					/*				if(colorSet){
										materials.materials["Material_#35"].color.r=r;
										materials.materials["Material_#35"].color.g=g;
										materials.materials["Material_#35"].color.b=b;
										materials.materials.textile_2.color.r=r;
										materials.materials.textile_2.color.g=g;
										materials.materials.textile_2.color.b=b;
									}else{
										materials.materials.textile_2.color.r=materials.materials["Material_#35"].color.r;
										materials.materials.textile_2.color.g=materials.materials["Material_#35"].color.g;
										materials.materials.textile_2.color.b=materials.materials["Material_#35"].color.b;
									}
									pushingKoeficient = 0.2;
									object.position.set(0,-13,-3.5);
									object.scale.set(20,20,20);
									object.rotateX(-1.5707963);
									object.rotateZ(0.1);
									//material=2;*/
								//	object.position.set(-1,-21,-3); medium
								//	object.scale.set(8,8,8);
								//	beltHight = 5;
								//	beltNormalMatching=0;
								//	shirtBeltSimulationException = true;
									break;
							case 2: //object.position.set(0,-92,-4);
									//object.position.set(0,-70,-4);//max
									//object.position.set(0,-107,-4);//min
									firstGravityChange = false;
									firstGravityChange2 = false;
									
									if(colorSet){
										materials.materials.tee.color.r=r;
										materials.materials.tee.color.g=g;
										materials.materials.tee.color.b=b;
									}
							console.log(velikost);
							switch(velikost){
								case 0:
										var why = -85;
										var diffEnota2 = 40.0/62.0;
										var hightValue = measurement_sliders[0].slider( "value");	
										why+=(hightValue-137)*diffEnota2;
										object.position.set(0,why,-4);//happy medium
									//	object.position.set(0,-85,-2);// mogoce minimum last min
										object.scale.set(60,60,60);  // last min
										firstGravityChange2 = true;
						//				material=14.381;
							//			material = 10;
							//			material = 5;
							//			material = 5;
							//			material = 2;
							//			material = 4;
									//	material = -1;
									//	material = 2;
										maxFrame = 300;
										//GRAVITY1 = 981 * 0.0014;
										//gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
										break;
								case 1: //0ins 0 high
										//object.position.set(0,-95.5,-4);
										//max ins 0 high
										var why = -95.5;
										var diffEnota2 = 37.0/62.0;
										var hightValue = measurement_sliders[0].slider( "value");	
										why+=(hightValue-137)*diffEnota2;
										object.position.set(0,why,-4);//happy medium
										object.scale.set(70,70,70);
										//0 ins 0 hight
										if(shirtStiffness == 1){
											pushingKoeficient = 0.8;
										}else{
											pushingKoeficient = 0.2;
										}
										maxFrame=101;
										break;
								case 2:
					//					material=14.381;
									//	material = 8;
										var why = -106;
										var diffEnota2 = 34.0/62.0;
										var hightValue = measurement_sliders[0].slider( "value");	
										why+=(hightValue-137)*diffEnota2;
										object.position.set(0,why,-4);//happy medium
										//if(measurement_sliders[2].slider( "value") <= 110){
										//	object.scale.set(75,75,75);
										//}
										//else{
											object.scale.set(80,80,80);
									//	}
						//				material = 10;
						//				material = 2;
										//material = 4;
										//material = -1;
										pushingKoeficient = 0.2;
										console.log("WTF MANNN");
										break;
								case 3:
										var why = -130;
										var diffEnota2 = 36.0/62.0;
										var hightValue = measurement_sliders[0].slider( "value");	
										why+=(hightValue-137)*diffEnota2;
										object.position.set(0,why,-4);//happy medium
										//object.position.set(0,-90,0);
										object.scale.set(90,90,90);
										pushingKoeficient = 0.2;
						//				material=20.381;
						//				scale *= 1;
							//			material=10;
							//			material = 2;
							//			material = 4;
								//		material = -1;
										break;
								case 4:
										var why = -130;
										var diffEnota2 = 37.5/62.0;
										var hightValue = measurement_sliders[0].slider( "value");	
										why+=(hightValue-137)*diffEnota2;
										object.position.set(0,why,-4);//happy medium
										//object.position.set(0,-90,0);// big maybe
										object.scale.set(110,90,110);
										pushingKoeficient = 0.2;
							//			material=20.381;
								//		material = 17.5;
								//		material = 2;
								//		material = 4;
									//	GRAVITY1 = 981 * 0.014;
										//gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
									//	material = -1;
										break;
								default:
							}
									break;
							case 3: 
									if(colorSet){
										materials.materials.wire_134006006.color.r=r;
										materials.materials.wire_134006006.color.g=g;
										materials.materials.wire_134006006.color.b=b;										
									}
									
									shirtMaterial=-1;
									switch(velikost){
									case 0: //0 ins 0 high
										//	object.position.set(0,-25,-3);// turtle
										//	object.scale.set(0.5,0.5,0.5);
											//max ins 0 high
											//object.position.set(0,-22,-3);
											//object.scale.set(0.5,0.5,0.5);
											//max ins max high
											//object.position.set(0,15,-3);
											//object.scale.set(0.5,0.5,0.5);
											var why = -25;
											var diffEnota = 3.0/42.0;
											var inseamValue =  measurement_sliders[5].slider( "value");
											why+=(inseamValue-57)*diffEnota;
											var diffEnota2 = 37.0/62.0;
											var hightValue = measurement_sliders[0].slider( "value");
											why+=(hightValue-137)*diffEnota2;
											object.position.set(0,why,-3);
											object.scale.set(0.5,0.5,0.5);
											if(shirtStiffness == 1 ){
												pushingKoeficient = 0.3;
												maxFrame=126;
											}else{
												pushingKoeficient = 0.3;
												shirtMaterial = 5;
												firstGravityChange = true;
												maxFrame=50;
											}
											break;
									case 1: //0 ins 0 high
											//object.position.set(0,-31.5,-3);
											//max ins 0 high
											//object.position.set(0,-28,-3);
											//object.position.set(0,9,-3);
											var why = -31.5;
											var diffEnota = 3.5/42.0;
											var inseamValue =  measurement_sliders[5].slider( "value");
											why+=(inseamValue-57)*diffEnota;
											var diffEnota2 = 37.0/62.0;
											var hightValue = measurement_sliders[0].slider( "value");
											why+=(hightValue-137)*diffEnota2;
											object.scale.set(0.6,0.6,0.6);
											object.position.set(0,why,-3);
											pushingKoeficient = 0.4;
											maxFrame = 200;
									
											break;
									case 2: //object.position.set(0,-20,-5.5);// turtle
											// ce je suh je treba pristet na -1.5 z
											object.scale.set(0.7,0.68,0.7);
											//0 ins 0 high
										//	object.position.set(0,-38,-5.5);
											//max ins 0 high
											//object.position.set(0,-35,-5.5);
											//max ins max high
										//	object.position.set(0,2,-5.5);
											var z = -5.5;
											var why = -38;
											var diffEnota = 3.0/42.0;
											var inseamValue =  measurement_sliders[5].slider( "value");
											why+=(inseamValue-57)*diffEnota;
											var diffEnota2 = 37.0/62.0;
											var hightValue = measurement_sliders[0].slider( "value");
											why+=(hightValue-137)*diffEnota2;
											var sum = measurement_sliders[1].slider( "value")+
											measurement_sliders[2].slider( "value")+
											measurement_sliders[3].slider( "value")+
											measurement_sliders[4].slider( "value");
											if(sum < 256){
												z= -1.5;
											}
											object.position.set(0,why,z);
											if(shirtStiffness == 1 ){
												pushingKoeficient = 0.8;
												maxFrame=200;
											}else{
												pushingKoeficient = 1;
												maxFrame = 80;
											}
											//maxFrame=300;
											break;
									case 3:	//max ins max high
											//object.position.set(0,-9,-4); //ce je ludek suh je treba zmanjsat
											//0 ins 0 high
											//object.position.set(0,-49,-4);
											//max ins 0 high
											//object.position.set(0,-43,-4);
											
											object.scale.set(0.8,0.8,0.8);
											var z = -4;
											var why = -49;
											var diffEnota = 6.0/42.0;
											var inseamValue =  measurement_sliders[5].slider( "value");
											why+=(inseamValue-57)*diffEnota;
											var diffEnota2 = 34.0/62.0;
											var hightValue = measurement_sliders[0].slider( "value");
											why+=(hightValue-137)*diffEnota2;
											var sum = measurement_sliders[1].slider( "value")+
											measurement_sliders[2].slider( "value")+
											measurement_sliders[3].slider( "value")+
											measurement_sliders[4].slider( "value");
											if(sum < 256){
												z= -1;
											}
											object.position.set(0,why,z);
											break;
									case 4:	
											//object.position.set(0,-15,-4);// turtle
											//object.position.set(0,-15,-1); ce je ludek suh je treba zmanjsat
											object.scale.set(0.9,0.9,0.9);
											//0 ins 0 high
										//	object.position.set(0,-50,-4);
											//max ins 0 high
										//	object.position.set(0,-47,-4);
											//max ins max high
										//	object.position.set(0,-15,-4);
											var z = -4;
											var why = -50;
											var diffEnota = 3.0/42.0;
											var inseamValue =  measurement_sliders[5].slider( "value");
											why+=(inseamValue-57)*diffEnota;
											var diffEnota2 = 32.0/62.0;
											var hightValue = measurement_sliders[0].slider( "value");
											why+=(hightValue-137)*diffEnota2;
											var sum = measurement_sliders[1].slider( "value")+
											measurement_sliders[2].slider( "value")+
											measurement_sliders[3].slider( "value")+
											measurement_sliders[4].slider( "value");
											if(sum < 256){
												z= -1;
											}
											object.position.set(0,why,z);
											firstGravityChange = true;
											if(shirtStiffness == 1){
												pushingKoeficient = 1;
												maxFrame = 230;
											}
											else{
												pushingKoeficient = 1;
												//maxFrame = 300;
												//material = 10;
											}
											//maxFrame = 80;

											break;
									default:
									}
									break;
				/*			case 4:
									if(colorSet){
										materials.materials.tee.color.r=r;
										materials.materials.tee.color.g=g;
										materials.materials.tee.color.b=b;
									}
									var why = -106;
									var diffEnota2 = 36.0/62.0;
									var hightValue = measurement_sliders[0].slider( "value");	
									why+=(hightValue-137)*diffEnota2;
									object.position.set(0,why,-4);
									if(measurement_sliders[2].slider( "value") <= 110)
										object.scale.set(75,75,75);
									else
										object.scale.set(78,78,78);
									material=2;
									break;*/
									
							default:
						}
							oblacilo1=object;
							oblacilo1.updateMatrixWorld();
							clothWorldMaths.push(oblacilo1.matrixWorld);
							clothWorldMathsInverses.push(new THREE.Matrix4().getInverse(oblacilo1.matrixWorld));
							if(clothIndex2 > 0){
								scene2.add( object );
							}else{
								scene.add(object);
								scene2 = null;
							}
							console.log(object);
							//console.log(object.geometry);

						});

					});
					
					
			/*		var loader = new THREE.OBJLoader();
					loader.load( 'three.js-master/examples/obj/clothes/female/dress/dse.obj', function ( object ) {

						object.traverse( function ( child ) {

							if ( child instanceof THREE.Mesh ) {

							//	child.material.map = texture;

							}

						} );

						object.scale.set(7,10,6.5);
						object.position.set(0,-122,-3);
						//scene.add( object );
						console.log(object.children[0].geometry.vertices);
						oblacilo1=object;
						oblacilo1.updateMatrixWorld();
						console.log("hmm");
						clothWorldMaths.push(oblacilo1.matrixWorld);
						clothWorldMathsInverses.push(new THREE.Matrix4().getInverse(oblacilo1.matrixWorld));
						
						console.log("hmm2");
						scene2.add( object );

					});*/
				}
				else{
					clothWorldMaths.push([]);
					clothWorldMathsInverses.push([]);
				}
				setTimeout(function(){
						if(clothIndex2 > 0){
							firstGravityChange = false;
							firstGravityChange2 = false;
							pushingKoeficient = 0.1;
							if(document.getElementById("pStiff").selected){
								pantsStiffness = 1;
							}else{
								pantsStiffness = 2;
							}
							beltHight = 3;
							beltNormalMatching = 0.5;
							pantsMaterial = -1;
							var velikost = -1;
							var sizeChoices = document.getElementById("pantsSizeSelection").childNodes;
							sizeChoices.forEach(function(opcija){
								if(!opcija.checked){
									return;
								}
								velikost = parseInt(opcija.getAttribute("value"));		
							});
							
							var arrayPathov = ['three.js-master/examples/obj/clothes/female/skirt2/',"three.js-master/examples/obj/clothes/female/skirt2/"];
							var arrayOfNames=["skirt22less","skirt"];
							
							var tex = new THREE.Texture();
							THREE.Loader.Handlers.add( /\.dds$/i, new THREE.DDSLoader() );
							var mtlLoader = new THREE.MTLLoader();
							mtlLoader.setPath(arrayPathov[clothIndex2-1]);
							mtlLoader.load(arrayOfNames[clothIndex2-1]+".mtl", function( materials ) {
						//	mtlLoader.setPath( 'three.js-master/examples/obj/clothes/female/shorts/' );
						//	mtlLoader.load( 'euphoria.mtl', function( materials ) {
						//	mtlLoader.setPath( 'three.js-master/examples/obj/clothes/female/hopefullyNewPants/' );
						//	mtlLoader.load( 'untitled4.mtl', function( materials ) {
						//	mtlLoader.setPath( 'three.js-master/examples/obj/clothes/female/skirt2/' );
						//	mtlLoader.load( 'skirt.mtl', function( materials ) {
						//	mtlLoader.load( 'skirt22less.mtl', function( materials ) {
							materials.preload();

								var objLoader2 = new THREE.OBJLoader();
								objLoader2.setMaterials( materials );
								objLoader2.setPath(arrayPathov[clothIndex2-1]);
								objLoader2.load(arrayOfNames[clothIndex2-1]+".obj", function ( object2 ) {
									GRAVITY2 = 981 * 0.0014;
									gravity2 = new THREE.Vector3( 0, - GRAVITY2, 0 ).multiplyScalar( MASS );
									switch(clothIndex2){
										case 1:		//object2.position.set(0,-85,0); happy medium
													//object2.scale.set(210,210,215);
													//0 hight 0 inseam
												//	object2.position.set(0,-102,0); 
												//	object2.scale.set(210,210,215);
													//0 hight max inseam
													//object2.position.set(0,-87,0); 
													//object2.scale.set(210,210,215);
													//max inseam max hight
												//	object2.position.set(0,-70,0); 
												//	object2.scale.set(210,210,215);	
												beltHight = 1;
												switch(velikost){
												case 0:	//object2.position.set(0,-85,0); 
														//0 hgh 0 inseam
													//	object2.position.set(0,-71,0.5); 
													//	object2.scale.set(133,133,133);
														//0high max inseam
													//	object2.position.set(0,-57,0.5); 
													//	object2.scale.set(133,133,133);
														//max inseam max hight
													//	object2.position.set(0,-43,0.5); 
													//	object2.scale.set(133,133,133);
													var why = -80;
													var diffEnota = 16.0/42.0;
													var inseamValue = measurement_sliders[5].slider( "value");
													why+=(inseamValue-57)*diffEnota;
													var diffEnota2 = 14.0/62.0;
													var hightValue = measurement_sliders[0].slider( "value");
													why+=(hightValue-137)*diffEnota2;
														object2.position.set(0,why,0.5); 
														object2.scale.set(133,150,133);
						//								beltHight = 2;
						//								var hip = 133; hipX = 133;
						//								var diffEnota = 200.0/79.0;
						//								var hipValue = measurement_sliders[4].slider( "value");	
						//								hip+=(hipValue-67)*diffEnota;
						//								var diffEnota2 = 140.0/79.0;
						//								hipX+=(hipValue-67)*diffEnota2;
						//								object2.scale.set(hipX,133,hip);
												//	object2.position.set(0,-77,0.5); 
												//	object2.scale.set(150,150,150.5);
														if(pantsStiffness == 1)
															pantsMaterial = 10;
														else
															pantsMaterial = -1;
														//maxFrame = 100;
												
												break;
												case 1:
													var why = -102;
													var diffEnota = 16.0/42.0;
													var inseamValue = measurement_sliders[5].slider( "value");
													why+=(inseamValue-57)*diffEnota;
													var diffEnota2 = 16.0/62.0;
													var hightValue = measurement_sliders[0].slider( "value");
													why+=(hightValue-137)*diffEnota2;
													object2.position.set(0,0,0); 
												//	object2.scale.set(210,(194+(inseamValue-57)*diffEnota),215);
													object2.position.set(0,why,0); 
													object2.scale.set(210,210,215);
													
													break;
												case 2:		
															//0 in 0 high
													//		object2.position.set(0,-107,0); 
													//		object2.scale.set(280,230,360);//240 240 240
															//0 high max ins
														//	object2.position.set(0,-93,0); 
															//max ins max high
														//	object2.position.set(0,-77,0); 
														var why = -107;
														var diffEnota = 14.0/42.0;
														var inseamValue =  measurement_sliders[5].slider( "value");
														why+=(inseamValue-57)*diffEnota;
														var diffEnota2 = 16.0/62.0;
														var hightValue = measurement_sliders[0].slider( "value");
														why+=(hightValue-137)*diffEnota2;
														object2.position.set(0,why,0); 
															object2.scale.set(255,230,255);
													break;
												default:
												}
													break;											
										case 2:		
										
													GRAVITY2 = 981 * 0.014;
													gravity2 = new THREE.Vector3( 0, - GRAVITY2, 0 ).multiplyScalar( MASS );
													switch(velikost){
														case 0:	//0 high 0 ins
															//	object2.position.set(-15,17.6,18);
																object2.scale.set(19,25,19);
																object2.rotateZ(0.31);
																object2.rotateX(0.13);
																//max ins 0 high
															//	object2.position.set(-15,32.5,18);
															//max ins max high
															//	object2.position.set(-15,47,18);
																var why = 17.6;
																var diffEnota = 15.0/42.0;
																var inseamValue =  measurement_sliders[5].slider( "value");
																why+=(inseamValue-57)*diffEnota;
																var diffEnota2 = 14.4/62.0;
																var hightValue = measurement_sliders[0].slider( "value");
																why+=(hightValue-137)*diffEnota2;
																beltNormalMatching = 0.8;
																object2.position.set(-15,why,18);
														
																break;
														case 1:
																//object2.position.set(-20,41,20);//default
																//0 hip default position
															//	object2.position.set(-19,41,17);
															//	object2.scale.set(25,30,25);
																//max hip default position
																//object2.position.set(-20,42,24);
																//object2.scale.set(35,30,35);
																var why = 28;
																var diffEnota = 15.0/42.0;
																var inseamValue =  measurement_sliders[5].slider( "value");
																why+=(inseamValue-57)*diffEnota;
																var diffEnota2 = 15.0/62.0;
																var hightValue = measurement_sliders[0].slider( "value");
																why+=(hightValue-137)*diffEnota2;
																object2.scale.set(30,30,30); //default
																object2.rotateZ(0.31);
																object2.position.set(-20,why,20);
																//0 hight 0 inseam
																//object2.position.set(-20,28,20);
																//0 hight max inseam
																//object2.position.set(-20,43,20);
															//	max hight max inseam
															//	object2.position.set(-20,58,20);
																
																//LETS DO THIS
																
																break;
														case 2:	//max high max inseam
															//	object2.position.set(-27,75,28);
																object2.scale.set(40,40,40);
																object2.rotateZ(0.31);
																var why = 43;
																var diffEnota = 16.0/42.0;
																var inseamValue =  measurement_sliders[5].slider( "value");
																why+=(inseamValue-57)*diffEnota;
																var diffEnota2 = 16.0/62.0;
																var hightValue = measurement_sliders[0].slider( "value");
																why+=(hightValue-137)*diffEnota2;
																object2.position.set(-27,why,28);
															//	0 high max ins
															//	object2.position.set(-27,59,28);
															//  0 high 0 ins
															//	object2.position.set(-27,43,28);
																break;
														default:
														
													}
													break;				
										default:
									}
							//	objLoader2.setPath( 'three.js-master/examples/obj/clothes/female/skirt2/' );
								//objLoader2.load( 'skirt.obj', function ( object2 ) {
							//	objLoader2.load( 'skirt22shadeless.obj', function ( object2 ) {
									//object2.position.set(-1,-70,1); //medium
									//object2.scale.set(69,73,70.5);
									//object2.position.set(-1,-70,1);//max hight
									//object2.scale.set(75,92,81.2);
									//object2.position.set(-1,-70,1);//max 2
									//object2.scale.set(77,92,81.5);
									//object2.position.set(0,-70,100);
									//object2.scale.set(70,73,70);
									//object2.scale.set(78,92,78);
									//object2.scale.set(60,60,60); //mini
						//			object2.position.set(0,-110,-2); shorts/
									//object2.position.set(0,-110,-2); last prev pants position
									//object2.scale.set(78,92,78);
									//ZACETEK INSEAM MERITEV
									//#1
									//object2.scale.set(78,60,78);//lowest inseam at lowest hight
									//#2
									//object2.scale.set(78,75,78);//highest inseam
						/*			var why = 60;
									var diffEnota = 15.0/44.0; maybe go with 16
									var inseamValue = measurement_sliders[5].slider( "value");
									
									why+=(inseamValue-60)*diffEnota;
									object2.scale.set(78,why,78);*/
									//#3
									//min inseam max hight, lowest inseam max hight= highest inseam, min hight
									//object2.scale.set(78,75,78);
									//#4
									//highest inseam max hight
									//object2.scale.set(78,92,78);
									//object2.scale.set(78,76,78);
							//		var why = 60;
							//		var diffEnota = 16.0/44.0;// maybe go with 16
							//		var inseamValue = measurement_sliders[5].slider( "value");			
							//		why+=(inseamValue-60)*diffEnota;
							//		var diffEnota2 = 16.0/66.0;
							//		var hightValue = measurement_sliders[0].slider( "value");	
							//		why+=(hightValue-148)*diffEnota2;
									//object2.scale.set(78,why,78);
									console.log(materials);
									
									
								//	object2.position.set(0,-78,-2); zadn pants 2
/* skirt 1 in map skirt2 trololo									object2.position.set(-20,41,20);
									object2.scale.set(30,30,30);
									object2.rotateZ(0.31);
									GRAVITY2 = 981 * 0.014;
									gravity2 = new THREE.Vector3( 0, - GRAVITY2, 0 ).multiplyScalar( MASS );
					*/				//pantsMultiplier = 50;
							/*		var r = parseInt(document.getElementById("rcolor").value) /255.0;
									console.log(r);
									var g = parseInt(document.getElementById("gcolor").value)/255.0;
									var b = parseInt(document.getElementById("bcolor").value)/255.0;
									var colorSet = false;
									if(!isNaN(r) && !isNaN(g) && !isNaN(b)){
										if(r >= 0  && r <= 1 && g >= 0 && g <= 1 && b >= 0 && b <= 1){
											colorSet = true
										}
									}
									if(colorSet){
										materials.materials.skirt.color.r=r;
										materials.materials.skirt.color.g=g;
										materials.materials.skirt.color.b=b;	
										materials.materials.belt.color.r=r;
										materials.materials.belt.color.g=g;
										materials.materials.belt.color.b=b;			
										materials.materials.metal.color.r=r;
										materials.materials.metal.color.g=g;
										materials.materials.metal.color.b=b;												
									}*/
									oblacilo2=object2;
									oblacilo2.updateMatrixWorld();
									clothWorldMaths.push(oblacilo2.matrixWorld);
									clothWorldMathsInverses.push(new THREE.Matrix4().getInverse(oblacilo2.matrixWorld));
									scene.add( object2 );
								//	maxFrame = 100;
									console.log(object2);

								});

							});
						}//else{
						//	clothWorldMaths.push([]);
						//	clothWorldMathsInverses.push([]);
						//}
				}, 20);
			}
			
			function setUpClothSimulation(){
				if(oblacilo1 != null){
					cloth = new Cloth(oblacilo1,0 );
					clothGeometry = oblacilo1.children[0].geometry;
					clothGeometry.dynamic = true;
				}
				if(oblacilo2 != null){
					cloth2 = new Cloth(oblacilo2,1 );
					clothGeometry2 = oblacilo2.children[0].geometry;
					clothGeometry2.dynamic = true;
				}
			}
			
			function init(clothPaint) {
				var container=document.getElementById("three");

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
				camera.position.z = 250;
				//camera.position.z = 500;
				//camera.position.z = 1000;

				// scene

				var ambient = new THREE.AmbientLight( 0x101030 );
				scene.add( ambient );
				if(scene2 != null){
					var ambient2 = new THREE.AmbientLight( 0x101030 );
					scene2.add(ambient2);
				}
				var directionalLight = new THREE.DirectionalLight( 0xffeedd,0.7 );
				//directionalLight.position.set( 0, 0, 1 );
				directionalLight.position.set( 0, 0, 1 );
				scene.add( directionalLight );
				var d2 = new THREE.DirectionalLight( 0xffeedd,0.6 );
				d2.position.set( 0.41, 0.82, 0.41 );
				scene.add( d2 );
				var directionalLight3 = new THREE.DirectionalLight( 0xffeedd,0.7 );
				//directionalLight.position.set( 0, 0, 1 );
				directionalLight3.position.set( 0, 0, -1 );
				scene.add( directionalLight3 );
				if(scene2 != null){
					var directionalLight222 = new THREE.DirectionalLight( 0xffeedd,0.7 );
					directionalLight222.position.set( 0, 0, 1 );
					var d222 = new THREE.DirectionalLight( 0xffeedd,0.6 );
					d222.position.set( 0.41, 0.82, 0.41 );
					var directionalLight322 = new THREE.DirectionalLight( 0xffeedd,0.7 );
					directionalLight322.position.set( 0, 0, -1 );
					scene2.add(directionalLight222);
					scene2.add(d222);
					scene2.add(directionalLight322);
				}
				// model
				
				geometry = new THREE.BufferGeometry();
				positions = templateVerticesMale.slice();
				normals = templateNormalsMale.slice();
				indices = templateIndicesMale;
				sf = scaleFactors;

				var meanScaleFactor = 0.0;var stevec = 0;
					for(var j = 0; j < sf.length;j++){
						meanScaleFactor += sf[j];
						//rokmadroksmash.push(sf[j]);
						stevec++;
					}
				//console.log(sf);
				var mean = 1.0-meanScaleFactor;
				
				for(i = 0; i < positions.length;i++){
					positions[i]*=mean;
				}

				for(var k = 0; k < 7;k++){
					var p1 = offsetVerticesMale[k];
					var n1 = offsetNormalsMale[k];
					for(i = 0;i < p1.length;i++){
						positions[i]+=p1[i]*sf[k];
						normals[i]+=n1[i]*sf[k];
					}	
				}
				//delete p1;
				//delete n1;
				
				
				geometry.addAttribute( 'position', new THREE.BufferAttribute( positions, 3 ) );
				geometry.addAttribute( 'normal', new THREE.BufferAttribute( normals, 3 ) );
				geometry.setIndex( new THREE.BufferAttribute( indices, 1 ) );
				geometry.computeBoundingBox();
				
				mesh = new THREE.Mesh(geometry,new THREE.MeshLambertMaterial( { color: 0x90BCF9}));
				//mesh = new THREE.Mesh(geometry,new THREE.MeshLambertMaterial( { color: 0x7D97E5,vertexColor: THREE.VertexColors }));
				mesh.scale.set(70,70,70);
				mesh.position.set(0,-70,0);
				mesh.updateMatrixWorld();
				var matix = mesh.matrixWorld;
				geometry.boundingBox.applyMatrix4(matix);
				scene.add(mesh);
				
		//		var helper = new THREE.VertexNormalsHelper( mesh, 2, 0x00ff00, 1 );
		//		scene.add(helper);


				//console.log(geometry.boundingBox);
				if(clothPaint && boxesList.length == 0){
					console.log("kio was the problem");
					var geoL = new THREE.Geometry();
					geoL.vertices=[];
					geoL.vertices.push(geometry.boundingBox.min);
					geoL.vertices.push(geometry.boundingBox.max);
					var origBox = geometry.boundingBox;
					var max = new THREE.Vector3().copy(origBox.max);
					var min = new THREE.Vector3().copy(origBox.min);
					var differ = (max.y - min.y)/15.0;
					sirinaSkatelj = differ;
					var max2= new THREE.Vector3().copy(max);
				/*	console.log("orig max");
					console.log(max);
					console.log("orig min");
					console.log(min);
					console.log(differ);*/
					for(var steve = 0; steve<15;steve++){
							var min2 = new THREE.Vector3().copy(min);
							min2.y+=differ*(14-steve);
			//				boxesList.push(new THREE.Box3(min2,max2));
			//				max2= new THREE.Vector3().copy(max);
			//				max2.y-=differ*(steve+1);
						var startX = min2.x;var startX2 = max2.x;
						var steviloSkatelj = 3;//stevilo vodoravnih boxov
						var differ2 = Math.abs(startX-startX2)/steviloSkatelj;
						for(var steve2 = 0; steve2 < steviloSkatelj; steve2++){
							var min3 = new THREE.Vector3().copy(min2);
							min3.x += differ2*steve2;
							max2 = new THREE.Vector3().copy(max2);
							max2.x = min2.x+(differ2*(steve2+1));
							boxesList.push(new THREE.Box3(min3,max2));	
						}
						//boxesList.push(new THREE.Box3(min2,max2));//tole se zakomentira ce delas z notranjimi boxi
						max2= new THREE.Vector3().copy(max);
						max2.y-=differ*(steve+1);
					}
					var bodyArray = geometry.getAttribute('position').array;
					var normalArray = geometry.getAttribute('normal').array;
					
					var normalMatrix = new THREE.Matrix3();
					normalMatrix.getNormalMatrix(mesh.matrixWorld);			
					for(var i = 0; i < boxesList.length;i++){
						boxesPoints.push([]);
						boxesNormals.push([]);
						for(var j=0;j < bodyArray.length;j=j+3){
							var pointek = new THREE.Vector3(bodyArray[j],bodyArray[j+1],bodyArray[j+2]);
							pointek.applyMatrix4(matix);
							//if(boxesList[i].containsPoint(pointek));{
								//console.log("wtf");
							//	boxesPoints[i].push(pointek);
							//}
							if(pointek.x <= boxesList[i].max.x && pointek.x >= boxesList[i].min.x)
							{
								if(pointek.y <= boxesList[i].max.y && pointek.y >= boxesList[i].min.y){
									if(pointek.z <= boxesList[i].max.z && pointek.z >= boxesList[i].min.z){
										
										boxesPoints[i].push(pointek);
										var normalP = new THREE.Vector3(normalArray[j],normalArray[j+1],normalArray[j+2]);
										normalP.applyMatrix3( normalMatrix ).normalize().add( pointek );
										boxesNormals[i].push(normalP);
									}
								}
							}
						}
					}
				}
				delete bodyArray; delete normalArray;  
			/*	for(var ij = 0; ij < boxesList.length;ij++){
					var linija = new THREE.Geometry();
					linija.vertices=[];
					linija.vertices.push(boxesList[ij].min);
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].min.x,boxesList[ij].min.y,boxesList[ij].max.z));
					linija.vertices.push(boxesList[ij].max);
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].min.x,boxesList[ij].max.y,boxesList[ij].min.z));
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].min.x,boxesList[ij].max.y,boxesList[ij].max.z));
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].max.x,boxesList[ij].max.y,boxesList[ij].min.z));
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].max.x,boxesList[ij].min.y,boxesList[ij].max.z));
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].max.x,boxesList[ij].min.y,boxesList[ij].min.z));

					var obLinija = new THREE.Line(linija,new THREE.LineBasicMaterial({color: 0xff0000}));
					scene.add(obLinija);
				}*/
				if(prvoRisanje){
					renderer = new THREE.WebGLRenderer();
					renderer.setPixelRatio( window.devicePixelRatio );
					renderer.setSize( window.innerWidth/1.5, window.innerHeight/1.5 );
					container.appendChild( renderer.domElement );
					rend = renderer;
					prvoRisanje = false;
					renderer.autoClear=false;
				}
				// controls
					var controls = new THREE.OrbitControls( camera, rend.domElement );
					controls.maxPolarAngle = Math.PI * 0.5;
					controls.minDistance = 100;
					controls.maxDistance = 500;
				
				window.addEventListener( 'resize', onWindowResize, false );
			}

			function onWindowResize() {

				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}


			//

			function animate() {
				//console.log(stevecLUL);
				//console.log(prejsniStevec);
				if(stevecLUL > prejsniStevec){
					//console.log("umm");
					prejsniStevec=stevecLUL;
					return;
				}
				requestAnimationFrame( animate );
				var time = Date.now();
				//console.log(frameCountLimit);
				//windStrength = Math.cos( time / 7000 ) * 20 + 40;
				//windForce.set( Math.sin( time / 2000 ), Math.cos( time / 3000 ), Math.sin( time / 1000 ) ).normalize().multiplyScalar( windStrength );
				if(cloth != null && cloth2 != null){
					if(frameCountLimit == -1 || frameCount < frameCountLimit){
						simulate( time );
					}
				}else
				{
					if(cloth != null || cloth2 != null){
						if(frameCountLimit == -1 || frameCount < frameCountLimit){
							if(frameCount % 2 == 0){
								simulate( time );
							}else{
								frameCount++;
							}
						}
					}
				}
				render();
				
			}
			
			
			function render() {

				//camera.position.x += ( mouseX - camera.position.x ) * .05;
				//camera.position.y += ( - mouseY - camera.position.y ) * .05;
				camera.lookAt( scene.position );
				if(cloth!=null){
					var p = cloth.particles;
					var ver = clothGeometry.getAttribute('position').array;
					//console.log("sledi pomemben log!");
					//console.log(ver);
					for ( var i = 0, il = p.length; i < il; i ++ ) {
						var kopija = new THREE.Vector3().copy(p[i].position).applyMatrix4(clothWorldMathsInverses[0]);
						ver[i*3]=kopija.x;
						ver[i*3+1]=kopija.y;
						ver[i*3+2]=kopija.z;
					}
					clothGeometry.attributes.position.needsUpdate = true;
					clothGeometry.computeFaceNormals();
					//clothGeometry.computeVertexNormals();
					clothGeometry.attributes.normal.needsUpdate = true;
				}
				if(cloth2 != null){
					var p2222 = cloth2.particles;
					var ver2222 = clothGeometry2.getAttribute('position').array;
					for ( var i = 0, il = p2222.length; i < il; i ++ ) {
						var kopija2222 = new THREE.Vector3().copy(p2222[i].position).applyMatrix4(clothWorldMathsInverses[1]);
						ver2222[i*3]=kopija2222.x;
						ver2222[i*3+1]=kopija2222.y;
						ver2222[i*3+2]=kopija2222.z;
					}
					clothGeometry2.attributes.position.needsUpdate = true;
					clothGeometry2.computeFaceNormals();
					//clothGeometry2.computeVertexNormals();
					clothGeometry2.attributes.normal.needsUpdate = true;
				}
				renderer.clear();
				renderer.render( scene, camera );
				renderer.clearDepth();
				if(scene2 != null)
					renderer.render(scene2,camera);
				

			}
	}
		/*	function onDocumentMouseMove( event ) {
				if(mouseDown){
					mouseX = ( event.clientX - windowHalfX ) / 2;
					mouseY = ( event.clientY - windowHalfY ) / 2;
				}

			}
			function onDocumentMouseDown( event ) {
				mouseDown=true;
			}
			function onDocumentMouseUp( event ) {
				mouseDown=false;
			}*/

	</script>
</head>
<body onpageshow="skrij()">
		<div id="sliderTry">
						<div id="sliders-column">
					<div id="slider-row-template" style="display:none;">
						<div class="slider-row" id="_string1_-slider-row">
							<div class="slider-label-div" id="_string1_-label-div">
								<span class="slider-label" id="_string1_-slider-label">_string2_: </span>
							</div>
							<div class="slider-value-div" id="_string1_-slider-value-div">
								<span class="slider-value" id="_string1_-slider-value">&nbsp;</span>
							</div>
							<div class="slider-units-div" id="_string1_-slider-units-div">
								<span class="slider-units" id="_string1_-slider-units">inches</span>
								<span class="slider-status" id="_string1_-slider-status"></span>
								<span class="slider-instructions" id="_string1_-slider-instructions">
									<a href="#" onClick='show_instructions("_string2_"); return false;'>(?)</a>
								</span>
							</div>
							<div class="measurement-slider" id="_string1_-measurement-slider"></div>
						</div>
					</div>
				<button id="resetButton" onclick="reset_all_sliders(6)">Reset all</button>
				<button id="switchUnits" onClick="toggle_units(); return false;">Switch Units</button>
				</div>
					<div id="sliders" style></div>
					<script>
						parent_element = $('sliders');
						template_element = $('slider-row-template');
						for (var i = 0; i < names.length; i++) {
							addElementFromTemplate(parent_element, template_element, ['_string1_','_string2_'], [names[i].toLowerCase(), names[i]]);
						}
						$J('#age-slider-units').html('years');
						$J('#weight-slider-units').html('pounds');
						$J('#exercise-slider-units').html('hours/week');
						measurement_slider_divs = $J('#sliders .measurement-slider');
						//console.log("meritev"+measurement_slider_divs);
						//wsetupSliders();
						setupSliders();
						for (var i = 0; i < 7; i++) {
							measurement_sliders[i].slider( "option", "disabled", false );
						}
						

					</script>
					

			
		<div id="popup" style="display: none;">
			<div id="popup_header"><a href="#" onClick="$J('#popup').hide(); return false;">CLOSE X</a></div>
			<div id="popup_content"></div>
		</div>		
		</div>
		<div id="three"></div>
					<script>start(false);</script>
		
		
</body>
</html>