<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	<script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script>
	<script type="text/javascript" src="js/jquery-timers.js"></script>
	<script type="text/javascript" src="js/prototype.js"></script>
	<script type="text/javascript" src="js/conditional_gaussian.js"></script>
	<script type="text/javascript" src="js/sylvester.js"></script>
	<link type="text/css" href="css/style.css?23" rel="stylesheet" />
	<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.16.custom.css" rel="stylesheet" />	
	<link type="text/css" href="innerStyle.css" rel="stylesheet" />	
	<script type="text/javascript" src="js/body_sliders.js?10"></script>
	<script src="three.js-master/build/three.js"></script>
	
	<script type="text/javascript" src="shapedata/male/all_male/chest.js"></script>
	<script type="text/javascript" src="shapedata/male/all_male/fitness.js"></script>
	<script type="text/javascript" src="shapedata/male/all_male/hip.js"></script>
	<script type="text/javascript" src="shapedata/male/all_male/stature.js"></script>
	<script type="text/javascript" src="shapedata/male/all_male/waist.js"></script>
	<script type="text/javascript" src="shapedata/male/all_male/weight.js"></script>
	<script type="text/javascript" src="shapedata/male/all_male/inseam.js"></script>
	<script type="text/javascript" src="shapedata/male/all_male/povprecje.js"></script>
	
	<!-- CLOTH SCRIPTS -->
	<script src="three.js-master/examples/js/Detector.js"></script>
	<script src="three.js-master/examples/js/controls/OrbitControls.js"></script>
	<script src="three.js-master/examples/js/libs/stats.min.js"></script>
	<script src="three.js-master/examples/js/loaders/OBJLoader.js"></script>
	<script src="three.js-master/examples/js/ClothRemake.js"></script>
	<script src="three.js-master/examples/js/loaders/DDSLoader.js"></script>
	<script src="three.js-master/examples/js/loaders/MTLLoader.js"></script>
	<div class="shirtStuff">
		<select id="selectShirt" onchange="skrijPrikazi()">
			<option id="0">/</option>
			<option id="1">shirt</option>
		</select>
	<select id="shirtMaterialSelection">
		<option id="sStiff">stiff shirt material</option>
		<option id="sSoft">soft shirt material</option>
	</select>
	<form action="" id="sizeSelection">
	  <input type="radio" name="size" value="0"> Small<br>
	  <input type="radio" name="size" value="1" checked="true"> Medium<br>
	  <input type="radio" name="size" value="2"> Large
	</form>
	<form action="demo_form.asp">
		  R: <input type="text" name="rcolor" id="rcolor" value="[0-255]"><br>
		  G: <input type="text" name="gcolor" id="gcolor" value="[0-255]"><br>
		   B: <input type="text" name="bcolor" id="bcolor" value="[0-255]"><br>
		</form>
	</div>
	<div class="pantsStuff">
		<select id="selectPants">
			<option id="0">/</option>
			<option id="1">pants</option>
		</select>
		<select id="pantsMaterialSelection">
			<option id="pStiff">stiff pants material</option>
			<option id="pSoft">soft pants material</option>
		</select>
		<form action="demo_form.asp">
		  R: <input type="text" name="rcolor" id="rpcolor" value="[0-255]"><br>
		  G: <input type="text" name="gcolor" id="gpcolor" value="[0-255]"><br>
		  B: <input type="text" name="bcolor" id="bpcolor" value="[0-255]"><br>
		</form>
	</div>
	<button id="startButton" onclick="start(false)">Start cloth simulation</button>
	<script>
			function skrijPrikazi(){
				var izbran = -1;
				var selection = document.getElementById("selectShirt").childNodes;
				selection.forEach(function(opcija){
				if(!opcija.selected){
					return;
				}
				izbran = parseInt(opcija.getAttribute("id"));		
			});
				if(izbran == 0){
					document.getElementById("sizeSelection").hide();
				}else{
					document.getElementById("sizeSelection").show();
				}
			}
			function skrij(){
				document.getElementById("sizeSelection").hide();
			}

	
			var loaded=false;
			var dostop = false;//ASDASD
			var renderer;
			var prvoRisanje = true;
			//TEMP VARIABLES
			var scaleFactors =[0.0,0.0,0.0,0.0,0.0,0.0,0.0];
			var measurement_sliders = null;
			//var measurement_slider_divs = null;
			//CAREFULL TOLE JE SAM ZA MALE!!
				var means = [ 8.944047e+02, 1.021941e+03, 1.029496e+03, 1.774263e+03, 4.350045e+00, 7.961530e+02, 4.559389e+00 ]; 
				var covariance = [
				[ 1.016833e+04, 8.356868e+03, 6.343672e+03, 2.546524e+03, 2.247066e+01, 2.354140e+02, -4.467876e+01 ],
				[ 8.356868e+03, 8.928956e+03, 5.700942e+03, 1.790792e+03, 2.122468e+01, 8.776439e+01, -1.711339e+01 ],
				[ 6.343672e+03, 5.700942e+03, 5.324874e+03, 2.119134e+03, 1.677411e+01, 5.787826e+02, -2.230402e+01 ],
				[ 2.546524e+03, 1.790792e+03, 2.119134e+03, 5.460447e+03, 8.908750e+00, 3.041366e+03, -7.780974e+00 ],
				[ 2.247066e+01, 2.122468e+01, 1.677411e+01, 8.908750e+00, 6.113030e-02, 2.705408e+00, -7.131429e-02 ],
				[ 2.354140e+02, 8.776439e+01, 5.787826e+02, 3.041366e+03, 2.705408e+00, 2.401288e+03, 2.883056e+00 ],
				[ -4.467876e+01, -1.711339e+01, -2.230402e+01, -7.780974e+00, -7.131429e-02, 2.883056e+00, 1.111947e+01 ]
				]; 
			//END OF TEMP
			
			function cross(a,b) {
				return [a[1]*b[2] - a[2]*b[1], a[2]*b[0] - a[0]*b[2], a[0]*b[1] - a[1]*b[0]];
			}
			function add(a,b) {
				return [a[0]+b[0], a[1]+b[1], a[2]+b[2]];
			}
			function sub(a,b) {
				return [a[0]-b[0], a[1]-b[1], a[2]-b[2]];
			}
			
			function flatten_two_d_array(two_d_array) {
				if (! two_d_array.length) { return []; }
				
				var height = two_d_array.length;
				var width = two_d_array[0].length;
				var length = height*width;
				var one_d_array = new Array(length);
				var index = length;
				for (i = height; i; ) {
					--i;
					for (j =  width; j; ) {
						one_d_array[--index] = two_d_array[i][--j];
					}
				}
				return one_d_array;
			}
			
			function initArray1D(length, value){
				var one_d_array = new Array(length);
				for (var i = length; i; ) { one_d_array[--i] = value; }
				return one_d_array
			}
			//IMPORTANT MODELS
			var templateVerticesMale=new Float32Array(flatten_two_d_array(mean_vertices));
			var templateIndicesMale=new Uint16Array(flatten_two_d_array(mean_faces));
			var offsetVerticesMale=[];
			
			
			//IZDELAVA NORMAL:
			offsetVerticesMaleStructured=[];
			offsetVerticesMaleStructured.push(stature_plus_5mm_vertices);
			offsetVerticesMaleStructured.push(weight_cube_root_plus_5kg_vertices);
			offsetVerticesMaleStructured.push(chest_circumference_plus_5mm_vertices);
			offsetVerticesMaleStructured.push(waist_circumference_pref_plus_5mm_vertices);
			offsetVerticesMaleStructured.push(hip_circumference_maximum_plus_5mm_vertices);
			offsetVerticesMaleStructured.push(inseam_right_plus_5mm_vertices);
			offsetVerticesMaleStructured.push(fitness_plus_5hours_vertices);
			
			for(var x = 0; x < 7;x++){
				offsetVerticesMale.push(new Float32Array(flatten_two_d_array(offsetVerticesMaleStructured[x])));
			}
			
			
			var tri = mean_faces;
			var vrt2tri = mean_vertices.map(function () { return []} );
			for (var i = 0; i < mean_faces.length; i++) {
				var face=mean_faces[i];
				vrt2tri[face[0]].push(i); vrt2tri[face[1]].push(i); vrt2tri[face[2]].push(i); 
			}
			var tx = mean_vertices;
			var scaled_normal=new Array(tri.length);
			var dscaled_normal=new Array(7);
			for(var oo=0; oo<7; ++oo) {
				dscaled_normal[oo]=new Array(tri.length);
			}
			for(var ii=0; ii < tri.length; ++ii) {
				var t=tri[ii];
				scaled_normal[ii]=cross(sub(tx[t[1]], tx[t[0]]), sub(tx[t[2]], tx[t[0]]));
		
				for(var oo=0; oo<offsetVerticesMaleStructured.length; ++oo) {
					var ox=offsetVerticesMaleStructured[oo];
					dscaled_normal[oo][ii]=add(cross(sub(tx[t[1]], tx[t[0]]), sub(sub(ox[t[2]],tx[t[2]]), sub(ox[t[0]],tx[t[0]]))), 
	                cross(sub(sub(ox[t[1]],tx[t[1]]), sub(ox[t[0]],tx[t[0]])), sub(tx[t[2]], tx[t[0]])));
				}
			}
			
			var template_normals = initArray1D(3*tx.length, 0.0);
			for(var i=0; i<tx.length; ++i) {
				var vertex_faces = vrt2tri[i];
				for (var j = 0; j < vertex_faces.length; j++) {
					template_normals[3*i] += scaled_normal[vertex_faces[j]][0];
					template_normals[3*i + 1] += scaled_normal[vertex_faces[j]][1];
					template_normals[3*i + 2] += scaled_normal[vertex_faces[j]][2];
				}
			}
			
			var dnormals = new Array(7);
			for(var oo=0; oo<7; ++oo) {
				dnormals[oo] = initArray1D(3*tx.length, 0.0);
				for(var i=0; i<tx.length; ++i) {
					var vertex_faces = vrt2tri[i];
					for (var j = 0; j < vertex_faces.length; j++) {
						dnormals[oo][3*i] += dscaled_normal[oo][vertex_faces[j]][0];
						dnormals[oo][3*i + 1] += dscaled_normal[oo][vertex_faces[j]][1];
						dnormals[oo][3*i + 2] += dscaled_normal[oo][vertex_faces[j]][2];
					}
				}
			}
			
			//KONEC IZDELAVE NORMAL
			var templateNormalsMale = new Float32Array(template_normals);
			delete template_normals;
			var offsetNormalsMale = [];
			for(var y = 0; y < 7;y++){
				offsetNormalsMale.push(new Float32Array(dnormals[y]));
				delete dnormals[y];
			}
			
			delete mean_vertices;delete mean_faces;
			for(var x = 0; x < 7;x++){
				delete offsetVerticesMaleStructured[x];
			}
			delete stature_plus_5mm_vertices;
			delete weight_cube_root_plus_5kg_vertices;
			delete chest_circumference_plus_5mm_vertices;
			delete waist_circumference_pref_plus_5mm_vertices;
			delete hip_circumference_maximum_plus_5mm_vertices;
			delete inseam_right_plus_5mm_vertices;
			delete fitness_plus_5hours_vertices;
			
			var names = ['Height', 'Weight', 'Chest', 'Waist', 'Hips', 'Inseam', 'Exercise'];
			var $J = jQuery.noConflict();
			var current_language = 'english';
			function addElementFromTemplate(parent_element, template_element, strings_to_replace, replacements) {
				template_html = replaceTextStrings($J(template_element).html(), strings_to_replace, replacements);
				$J(parent_element).append(template_html);
			}
			
			function isRegExp(obj) {  
				return Object.prototype.toString.call(obj) === '[object RegExp]';  
			};

			function replaceTextStrings(text, strings, replacements) {
				for (var i = 0; i < strings.length; i++) {
					if (isRegExp( strings[i] )) {
						text =  text.replace( strings[i], replacements[i]);
					} else {
						text =  text.replace(RegExp(strings[i], 'g'), replacements[i]);
					}
				}
				return text;
			}
			
			function setScalefactor(index, scalefactor){
				if(isNaN(scalefactor))
					return;
				scaleFactors[index] = scalefactor;

				
			}
			
				var show_instructions = function showInstructions(measurement_name) {
					var description_text = '<p>' + measurement_descriptions[current_language][measurement_name] + '</p>';
					if ((measurement_name != 'Age') && (measurement_name != 'Weight') && (measurement_name != 'Activity')) {
						description_text = description_text + '<p>' + measurement_descriptions[current_language]['general_advice'] + '</p>';
					}
					$J('#popup_content').html('<h3>' + measurement_name + '</h3>\n' + description_text);
					$J('#popup').show();
				}
				
			var measurement_descriptions = {}

			var english_measurement_descriptions = {
			'Height' :
			"Stand with the back of your head against the stadiometer&#39;s measuring stick. Keep your chin level, and do not tilt your head up or down. Move the measurement instrument to the top of your head, and note the measurement.",

			'Weight' :
			"Your weight, as measured by a standard bathroom scale.",

			'Age' :
			"Your current age in years.",

			'Chest' :
			"Measure the circumference of your chest at your nipple level. Hold the end of the measuring tape in the middle of your chest at your nipple level.\n\nEvenly wrap the measuring tape around your chest. Note the measurement at the point where the tape measure meets at the 0 mark.",

			'Waist' :
			"Measure the circumference of your waist at your preferred waistline. Your preferred waistline is where you typically wear the waist of your pants.\n\nAfter exhaling, hold the beginning of the measuring tape in front of your body in the middle of your waistline. Evenly wrap the measuring tape around your waist. Note the measurement at the point where the tape measure meets at the 0 mark.",

			'Hips' :
			"Measure the circumference of your hips at the level where your hips are widest.\n\nHold the beginning of the measuring tape in front of your body in the middle of your hip line. Evenly wrap the measuring tape around your hips. Note the measurement at the point where the tape measure meets at the 0 mark.",

			'Inseam' :
			"Measure your inseam from your crotch to the floor. Your crotch is the inner, uppermost point of leg.\n\nHold the beginning of the tape measure at your crotch. Make sure you are holding it at the 0 mark. Pull the tape measure down to the floor where your foot is situated. Note the measurement at the point where the tape measure meets at the 0 mark.",

			'Activity' :
			"Indicate your fitness level by specifying the hours per week you engage in structured physical activites",

			'general_advice' :
			"Note: When taking your measurements, relax your muscles and stand with weight equally distributed on both feet. Make sure that the measuring tape is kept at an even horizontal level around your body."
			}

			measurement_descriptions['english'] = english_measurement_descriptions;
			
				var units = 'english';
				var set_conversion_factor = function() {
					if (units == 'metric') {
						conversion_factor = { 'weight' : 1.0, 'height' : 1.0 };
					} else {
						conversion_factor = { 'weight' : 2.2, 'height' : 1.0/2.54 };
					}
				}
				set_conversion_factor();	
				
				var set_units = function(new_units) {
					if (units != new_units) { toggle_units(); }
				}
				
				var toggle_units = function() {
					var unit_divs = $J('.slider-units');
					if (units == 'metric') {
						units = 'english';
						for (var i = 0; i < unit_divs.length; i++) {
							var content = $J(unit_divs[i]).html();
							$J(unit_divs[i]).html(content.replace('kilograms', 'pounds').replace('centimeters', 'inches'));
						}
					} else {
						units = 'metric';
						for (var i = 0; i < unit_divs.length; i++) {
							var content = $J(unit_divs[i]).html();
							$J(unit_divs[i]).html(content.replace('pounds', 'kilograms').replace('inches', 'centimeters'));
						}
					}
					set_conversion_factor();
					for (var i = 0; i < measurement_sliders.length; i++) {
						var slider_value = measurement_sliders[i].slider( "value" );
						setSliderValueField(slider_value, measurement_value_fields[i], measurement_names[i]);
					}
				};
				
				//SLIDER HEEEEEELLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL
				
				var diff = 5;
	var update_in_progress = false;
	var updateMeasurementsAndModel = function(measurement_field_index, value, animate, callback) {
		if (! update_in_progress) {
			update_in_progress = true;
			old_scale_factors = scale_factors;
			scale_factors = Array(number_of_sliders);
			if (value == null) {
				conditional_multivariate_gaussian.uncondition_on_indices([measurement_field_index]);
				mark_slider_as_unfixed(measurement_field_index);
			} else {
				conditional_multivariate_gaussian.condition_on_indices([measurement_field_index], [value]);
				mark_slider_as_fixed(measurement_field_index);
			}
			for (var i = 0; i < number_of_sliders; i++) {
				var value = conditional_multivariate_gaussian.all_values[i];
				if (measurement_names[i] == 'weight') {
					var slider_value = Math.pow(value, 3);
				} else if (measurement_names[i] == 'exercise' ) {
					var slider_value = value;
				} else if (measurement_names[i] == 'age' ) {
					var slider_value = value;
				} else {
					var slider_value = value/10.0;
				}				
				measurement_sliders[i].slider( "value", slider_value );
				scale_factors[i] = (value - mu[i])/diff;
			}
			
			if (animate) {
				var number_of_increments = 8;
				var update_model_function = function(number_of_increments, start_values, end_values, callback) {
					return function(inc) {
						for (var i = 0; i < end_values.length; i++) {
							setScalefactor(i, start_values[i] + (inc/number_of_increments)*(end_values[i] - start_values[i]) );
							//console.log("startValues: "+start_values[i]+" inc: "+inc+" number_of_increments: "+number_of_increments+" end_values: "+end_values[i]);
						}
						//console.log("lets SEEEEEEE");
						//refreshModel();
						start(true);
						if ((inc == number_of_increments) && callback) { callback(); }
					}
				}(number_of_increments, old_scale_factors, scale_factors, callback);
				update_in_progress = false;
				$J(document).everyTime(30, update_model_function, number_of_increments);
			} else {
				for (var i = 0; i < number_of_sliders; i++) { setScalefactor(i, scale_factors[i]); }
				update_in_progress = false;
				//refreshModel();
				start(true);
			}
		}

		
				//	console.log(i + ' stops')
				//start(model_loader.current_model);
	}
	
	var reset_all_sliders_function = function(next_slider_to_reset) {
		return function() { return reset_all_sliders(next_slider_to_reset); }
	}
	
	function reset_all_sliders(next_slider_to_reset) {
		next_slider_to_reset = (next_slider_to_reset != undefined) ? next_slider_to_reset : (number_of_sliders - 1);
		if ((next_slider_to_reset < number_of_sliders) && (next_slider_to_reset >= 0)) {
			var callback = reset_all_sliders_function(next_slider_to_reset - 1);
			if (measurement_status[next_slider_to_reset] == 'fixed') {
				updateMeasurementsAndModel(next_slider_to_reset, null, true, callback);
			} else {
				callback();
			}
		}
		return false;
	}
	
	function mark_slider_as_fixed(slider_index) {
		measurement_status[slider_index] = 'fixed';
		measurement_value_fields[slider_index].addClass('fixed');
		measurement_sliders[slider_index].addClass('fixed');
		
		measurement_status_fields[slider_index].addClass('fixed');
		js_string = 'updateMeasurementsAndModel(' + slider_index + ', null, true); return false;'
		//console.log("plZZZ");
		link_html = (current_language == 'english') ? ('SET <a href="#" onClick="' + js_string + '">(click to reset)</a>') : ('SETZEN <a href="#" onClick="' + js_string + '">(zur\374cksetzen)</a>');
		measurement_status_fields[slider_index].html(link_html);
		update_reset_button();
	}
	function mark_slider_as_unfixed(slider_index) {
		//console.log("call me crazy");
		measurement_status[slider_index] = 'predicted';
		measurement_value_fields[slider_index].removeClass('fixed');
		measurement_sliders[slider_index].removeClass('fixed');
		
		measurement_status_fields[slider_index].removeClass('fixed');
		measurement_status_fields[slider_index].html((current_language == 'english') ? 'PREDICTED' : 'ERWARTET');
		update_reset_button();
	}
	
	function update_reset_button() {
		fixed_slider_count = 0;
		for (var i = 0; i < number_of_sliders; i++) {
			if (measurement_status[i] == 'fixed') { fixed_slider_count++; }
		}
		if (fixed_slider_count) { $J('#reset_button').show(); }
		else { $J('#reset_button').hide(); }
	}
	
	function setSliderValueField(slider_value, measurement_value_field, measurement_field_name) {
		if (measurement_field_name == 'weight') {
			measurement_value_field.text( Math.round(conversion_factor['weight']*slider_value) );
		} else if (measurement_field_name == 'exercise' ) {
			measurement_value_field.text( Math.round( slider_value/3.0 ) );
		} else if (measurement_field_name == 'age' ) {
			measurement_value_field.text( Math.round( slider_value ) );
		} else {
			measurement_value_field.text( Math.round(conversion_factor['height']*slider_value) );
		}
	}
	
	function sliderUpdateFunction(measurement_slider, measurement_value_field, measurement_field_name, measurement_field_index, animate) {
		return function() {
			if (! animate) { slide_counters[measurement_field_index] += 1; }
			var slider_value = measurement_slider.slider( "value" );
			setSliderValueField(slider_value, measurement_value_field, measurement_field_name);
			cached_slider_values[measurement_field_index] = slider_value;
			if(dostop){
			//if (model_loader.current_model) {
				if (measurement_field_name == 'weight') {
					var value = Math.pow(slider_value, 1/3);
				} else if (measurement_field_name == 'exercise' ) {
					var value = slider_value;
				} else if (measurement_field_name == 'age' ) {
					var value = slider_value;
				} else {
					var value = 10*slider_value;
				}
//				console.log(slide_counters)
				if (slide_counters[measurement_field_index] > 3) {
					if (animate) { slide_counters[measurement_field_index] = 0; }
					updateMeasurementsAndModel(measurement_field_index, value, false);
				} else {
					if (animate) { slide_counters[measurement_field_index] = 0; }
					updateMeasurementsAndModel(measurement_field_index, value, animate);
				}
			//}
			}
		}
	}
	
	function sliderStartsFunction(i) {
		return function() {
			//console.log(i + ' starts')
			slide_counters[i] = 0;
		}
	}
	
	function sliderStopsFunction(i) {
		return function() {
			//console.log(i + ' stops')

		}
	}

	var ordering_of_data = [ 'waist', 'chest', 'hips', 'height', 'weight', 'inseam', 'exercise' ];
//	var ordering_of_data = [ 'waist', 'chest', 'hips', 'height', 'weight', 'inseam', 'age' ];
	
//	var min_values = { 'height': 110, 'weight': 30, 'age': 18, 'waist' : 50, 'inseam' : 50, 'chest' : 60, 'hips' : 60, 'exercise': 0 };
//	var max_values = { 'height': 220, 'weight': 250, 'age': 90, 'waist' : 200, 'inseam' : 140, 'chest' : 200, 'hips' : 220, 'exercise': 10 };
//	var initial_values = { 'height' : 164, 'weight': 65, 'age': 40, 'waist' : 77, 'inseam' : 75, 'chest' : 94, 'hips' : 103, 'exercise': 4 };

	var min_values = {};
	var max_values = {};
	var initial_values = {};
	var stds = {};
	var order_by_measurement = {};	
	for (var i = 0; i < ordering_of_data.length; i++) { order_by_measurement[ordering_of_data[i]] = i; }
	var measurement_slider_divs = null;	
	var number_of_sliders = null;
	//var measurement_sliders = null;
	var measurement_names = null;
	var measurement_value_fields = null;
	var measurement_status_fields = null;
	var measurement_status = null;
	var cached_slider_values = null;
	var fixed_slider_count = 0;
	var slide_counters = null;
	
	var mu = null;
	var sigma = null;
	var conditional_multivariate_gaussian = null;
	
	function setupSliders() {
		for (var i = 0; i < ordering_of_data.length; i++) {
			order_by_measurement[ordering_of_data[i]] = i;
			initial_values[ordering_of_data[i]] = means[i]/10.0;
			stds[ordering_of_data[i]] = Math.sqrt(covariance[i][i])/10.0;
		}
		initial_values['age'] = 10*initial_values['age'];
		initial_values['exercise'] = 10*initial_values['exercise'];
		initial_values['weight'] = 10*initial_values['weight'];
		stds['age'] = 10*stds['age'];
		stds['exercise'] = 10*stds['exercise'];
		stds['weight'] = 10*stds['weight'];
    
		for (var i = 0; i < ordering_of_data.length; i++) {
			min_values[ordering_of_data[i]] = Math.round(initial_values[ordering_of_data[i]] - 4*stds[ordering_of_data[i]]);
			min_values[ordering_of_data[i]] = Math.max(min_values[ordering_of_data[i]], 0)
			max_values[ordering_of_data[i]] = Math.round(initial_values[ordering_of_data[i]] + 5*stds[ordering_of_data[i]]);
		}
    
		initial_values['weight'] = Math.pow(initial_values['weight'], 3);
		//min_values['weight'] = Math.pow(min_values['weight'], 3);
		min_values['weight'] = 45;
		//max_values['weight'] = Math.pow(max_values['weight'], 3);
		max_values['weight'] = 132;
		max_values['exercise'] = 60;
		number_of_sliders = measurement_slider_divs.length;
		measurement_sliders = Array(number_of_sliders)
		measurement_value_fields = Array(number_of_sliders);
		measurement_names = Array(number_of_sliders);
		measurement_value_fields = Array(number_of_sliders);
		measurement_status_fields = Array(number_of_sliders);
		measurement_status = Array(number_of_sliders);
		cached_slider_values = Array(number_of_sliders);
		scale_factors = Array(number_of_sliders);
		slide_counters = Array(number_of_sliders);
		
		mu = Array(number_of_sliders);
		sigma = Array(number_of_sliders);
		var unconditioned_indices = Array(number_of_sliders);
		var conditioned_indices = [];
		var conditioned_values = [];
		for (var i = 0; i < number_of_sliders; i++) {
			var measurement_name = measurement_slider_divs[i].id.replace('-measurement-slider','');
			var measurement_slider = $J(measurement_slider_divs[i])
			var measurement_value_field = $J('#' + measurement_name + '-slider-value');
			var measurement_status_field = $J('#' + measurement_name + '-slider-status');
			measurement_names[i] = measurement_name;
			measurement_sliders[i] = measurement_slider;
			measurement_value_fields[i] = measurement_value_field;
			measurement_status_fields[i] = measurement_status_field;
			measurement_slider.slider({
				orientation: "horizontal",
				range: "min",
				min: min_values[measurement_name],
				max: max_values[measurement_name],
				value: initial_values[measurement_name],
				start: sliderStartsFunction(i),
				stop: sliderStopsFunction(i),
				slide: sliderUpdateFunction(measurement_slider, measurement_value_field, measurement_name, i, false),
				change: sliderUpdateFunction(measurement_slider, measurement_value_field, measurement_name, i, true),
				animate: 300,
				disabled: true
			});
			data_index = order_by_measurement[measurement_name];
			mu[i] = means[data_index];
			unconditioned_indices[i] = i;
			sigma[i] = Array(number_of_sliders);
		}
		for (var i = 0; i < number_of_sliders; i++) {
			var row_data_index = order_by_measurement[measurement_names[i]];
			for (var j = 0; j < number_of_sliders; j++) {
				var column_data_index = order_by_measurement[measurement_names[j]];
				sigma[i][j] = covariance[row_data_index][column_data_index];
			}
			
		}
		conditional_multivariate_gaussian = new ConditionalMultivariateGaussian(mu, sigma, unconditioned_indices, conditioned_indices, conditioned_values);
		for (var i = 0; i < number_of_sliders; i++) {
			mark_slider_as_unfixed(i);
			measurement_sliders[i].slider( "value", initial_values[measurement_names[i]] );
			cached_slider_values[i] = initial_values[measurement_names[i]];
			scale_factors[i] = 0;

		}
		fixed_slider_count = 0;
		dostop = true;
		covariance = undefined;
		means = undefined;
	}
				var mouseX = 0, mouseY = 0;

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;
			var mouseDown = false;
			var clothWorldMaths=[];
			var clothWorldMathsInverses=[];
			var clothGeometry = null;
			var clothGeometry2 = null;
			var oblacilo1 = null;
			var oblacilo2 = null;
			
			var boxesList=[];
			var boxesPoints=[];
			var boxesNormals=[];
			var sirinaSkatelj = 0;
			var stevecLUL = 0;
			var prejsniStevec = 1;
			scene = null;
			scene2 = null;
			var rend = null;
			geometry = null;
			positions = null;
			normals = null;
			indices = null;
			sf = null;
			mesh = null;
			camera  = null;
	function start(eventHandler){
			if(frameCount != 0){
				frameCount = 0;
			}
			if(clothWorldMaths.length != 0){
				clothWorldMaths = [];
			}
			if(clothWorldMathsInverses.length != 0){
				clothWorldMathsInverses = [];
			}
			if(clothGeometry != null){
				clothGeometry = null;
			}
			if(clothGeometry2 != null){
				clothGeometry2 = null;
			}
			if(cloth != null){
				cloth = null;
			}
			if(cloth2 != null){
				cloth2 = null;
			}
			if(oblacilo1 != null){
				oblacilo1 = null;
			}
			if(oblacilo2 != null){
				oblacilo2 = null;
			}
			if(camera != null){
				delete camera;
			}
			if(positions != null){
				delete positions;
			}
			if(normals != null){
				delete normals;
			}
			if(indices != null){
				delete indices;
			}
			if(sf != null){
				delete sf;
			}
			if(geometry != null){
				delete geometry.getAttribute('position').array;
				delete geometry.getAttribute('normal').array;
				delete geometry.getAttribute('position');
				delete geometry.getIndex().array;
				delete geometry.boundingBox;
				delete geometry;
			}
			if(mesh != null){
				delete mesh;
			}
			stevecLUL++;
			//console.log(stevecLUL);
			if(scene != null)
				delete scene;
			if(scene2 != null)
				scene2 = null;
			scene = new THREE.Scene();
			var sele = document.getElementById("selectShirt").childNodes;
			var sele2 = document.getElementById("selectPants").childNodes;
			var loadingIndex1=-1;
			var loadingIndex2=-1;
			sele.forEach(function(opcija){
				if(!opcija.selected){
					return;
				}
				loadingIndex1 = parseInt(opcija.getAttribute("id"));		
			});
			sele2.forEach(function(opcija){
				if(!opcija.selected){
					return;
				}
				loadingIndex2 = parseInt(opcija.getAttribute("id"));		
			});
					

			var clothPaint = true;
			if(loadingIndex1 < 1 && loadingIndex2 < 1){
				clothPaint = false;
				if(boxesList.length != 0){
					boxesList = [];
				}
				if(boxesPoints.length != 0){
					boxesPoints = [];
				}
				if(boxesNormals.length != 0){
					boxesNormals = [];
				}
			}
			if(eventHandler){
				clothPaint = false;
			}
			if(clothPaint){
				document.getElementById("sliderTry").hide();
				document.getElementById("startButton").innerHTML="Restart simulation";
			}else{
				document.getElementById("sliderTry").show();
				document.getElementById("startButton").innerHTML="Start cloth simulation";
			}
			if(clothPaint){
		//		if(!loaded){
					loadCloth(loadingIndex1,loadingIndex2);
				
					setTimeout(function(){
				//		if(loadingIndex2 < 1){
							setUpClothSimulation();
					//	}else{
					//		clothPaint = false;
				//		}
						init(clothPaint);
						animate();
					}, 1000);
	/*			}
				else{
					
					scene.add( oblacilo1 );
					setUpClothSimulation();
					init(clothPaint);
					animate();
				}*/
			}
			else{
				//scene.add( oblacilo1 );
				//setUpClothSimulation();
				init(clothPaint);
				//stevecLUL=prejsniStevec;
			//	console.log("-------");
			//	console.log(stevecLUL);
			//	console.log(prejsniStevec);
				animate();
			}
			function loadCloth(clothIndex,clothIndex2){
			
				if(clothIndex > 0){
					var r = parseInt(document.getElementById("rcolor").value) /255.0;
					var g = parseInt(document.getElementById("gcolor").value)/255.0;
					var b = parseInt(document.getElementById("bcolor").value)/255.0;
					var colorSet = false;
					if(!isNaN(r) && !isNaN(g) && !isNaN(b)){
						if(r >= 0  && r <= 1 && g >= 0 && g <= 1 && b >= 0 && b <= 1){
							colorSet = true
						}
					}
					var vsotaVisin = measurement_sliders[0].slider( "value")+measurement_sliders[5].slider( "value");
					var vsotaOblin = measurement_sliders[1].slider( "value")+measurement_sliders[2].slider( "value")+measurement_sliders[3].slider( "value")+measurement_sliders[4].slider( "value");
					var odstotek = vsotaVisin/vsotaOblin;
					if(document.getElementById("sStiff").selected){
						shirtStiffness = 1;
					}else{
						shirtStiffness = 2;
					}
					var velikost = -1;
					scale = 1;
					var sizeChoices = document.getElementById("sizeSelection").childNodes;
					sizeChoices.forEach(function(opcija){
						if(!opcija.checked){
							return;
						}
						velikost = parseInt(opcija.getAttribute("value"));		
					});
					scene2 = new THREE.Scene();
					var tex = new THREE.Texture();
					//GRAVITY1 = 981 * 0.14/4;
					GRAVITY1 = 981 * 0.014*5;
					gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
					shirtMaterial = 2;
					firstGravityChange = true;
					THREE.Loader.Handlers.add( /\.dds$/i, new THREE.DDSLoader() );

					var mtlLoader = new THREE.MTLLoader();
					mtlLoader.setPath( 'three.js-master/examples/obj/clothes/shirt/Cloth_t-shirt-obj/' );
					mtlLoader.load( 'T-shirt-male-obj.mtl', function( materials ) {

						materials.preload();

						var objLoader = new THREE.OBJLoader();
						objLoader.setMaterials( materials );
						
						objLoader.setPath( 'three.js-master/examples/obj/clothes/shirt/Cloth_t-shirt-obj/' );
						objLoader.load( 'T-shirt-male-obj.obj', function ( object ) {
							
							var buff = new THREE.Geometry();
							buff.fromBufferGeometry(object.children[0].geometry);
							buff.mergeVertices();
							buff.verticesNeedUpdate = true;
						//	console.log(object.children[0].geometry.attributes);
							object.children[0].geometry.morphAttributes.position= buff.morphTargets;
							object.children[0].geometry.attributes.position.needsUpdate = true;
							object.children[0].geometry.computeFaceNormals();
					//clothGeometry.computeVertexNormals();
							object.children[0].geometry.attributes.normal.needsUpdate = true;
						//	var obj2 = new THREE.BufferGeometry();
						//	obj2.fromGeometry(buff);
						//	object.children[0].geometry=obj2;
							//object.position.set(19,-17.8,1);default
							//object.scale.set(3.01,3.01,3.01);
							//object.position.set(19,-35,1); min hight
							//object.scale.set(3.01,3.01,3.01);
							//object.position.set(19,0,1); max hight
							//object.scale.set(3.01,3.01,3.01);
							//object.scale.set(3.01,3.01,3.01);//happy medium
							//object.position.set(19,why,1); //max hight happy medium
							//MINMUM TESTING
						//	object.scale.set(2.5,2.5,2.6);
		/*					var why = -35;
							var diffEnota2 = 35.0/66.0;
							var hightValue = measurement_sliders[0].slider( "value");	
							why+=(hightValue-148)*diffEnota2;
							vsota = measurement_sliders[0].slider( "value")+	
							measurement_sliders[1].slider( "value")+	
							measurement_sliders[2].slider( "value")+	
							measurement_sliders[3].slider( "value")+	
							measurement_sliders[4].slider( "value");
							console.log(vsota);
							if(vsota > 770)
								why+=5;*/
						//	object.position.set(16,-27,1); //max hight||| minimum
							//object.scale.set(3.1,3.1,3.1);
							
							//MAXIMUM TESTING
							//object.scale.set(3.4,3.4,3.4);//highest
							//object.position.set(22,-3,1);//
							if(colorSet){
								materials.materials.T_shirt.color.r=r;
								materials.materials.T_shirt.color.g=g;
								materials.materials.T_shirt.color.b=b;
							}
							switch(velikost){
								case 0: object.scale.set(2.5,2.5,2.6);
										//object.position.set(16,-27,1);
										//object.position.set(16,-27,1);
										var why = -27;
										var diffEnota2 = 35.0/66.0;
										var hightValue = measurement_sliders[0].slider( "value");	
										why+=(hightValue-148)*diffEnota2;
										var vsota = measurement_sliders[5].slider( "value");	
										if(vsota > 80)
											why+=5;
										object.position.set(15,why,1);
										shirtMaterial = 4;
										firstGravityChange = false;firstGravityChange2 = false;
										if(shirtStiffness == 2){
											pushingKoeficient = 0.7;
										}
										else{
											GRAVITY1 = 981 * 0.0014;
											gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
										}
										maxFrame = 200;
										break;
								case 1: var why = -35;
										var diffEnota2 = 32/66.0;
										var hightValue = measurement_sliders[0].slider( "value");	
										why+=(hightValue-148)*diffEnota2;
										var vsota = measurement_sliders[5].slider( "value");	
										if(vsota > 80)
											why+=7;
										object.scale.set(3.01,3.01,3.01);
										object.position.set(19,why,1);
										shirtMaterial = -1;
										if(shirtStiffness == 1){
											GRAVITY1 = 981 * 0.14;
											gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
											firstGravityChange = false;firstGravityChange2 = false;
											scale = 6;
											pushingKoeficient = 0.3;maxFrame = 150;
										}
										else{
											firstGravityChange = false;firstGravityChange2 = false;
											GRAVITY1 = 981 * 0.014*5;
											gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
											scale = 3;
											pushingKoeficient = 1;
											maxFrame = 150;
										}
										if(odstotek > 0.85){
											GRAVITY1 = 981 * 0.014*5;
											gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
											object.position.z+=1;
										}
										break;
										
								case 2: 
										firstGravityChange = false;firstGravityChange2 = false;
										if(shirtStiffness == 1){
											GRAVITY1 = 981 * 0.14;
											gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
											//firstGravityChange = false;firstGravityChange2 = false;
											//scale = 6;
											pushingKoeficient = 0.3;
											maxFrame = 150;
											scale=7.5;
										}else{
									
											GRAVITY1 = 981 * 0.014*5;
											gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
											scale = 4;
											pushingKoeficient = 1;
											maxFrame = 200;
										}
										object.scale.set(3.4,3.4,3.4);
										var why = -44;
										var diffEnota2 = 32/66.0;
										var hightValue = measurement_sliders[0].slider( "value");	
										why+=(hightValue-148)*diffEnota2;
										var vsota = measurement_sliders[5].slider( "value");
										if(vsota > 80)
											why+=7.5;
										object.position.set(21,why,2);
										shirtMaterial = -1;
										if(odstotek > 0.85){
											GRAVITY1 = 981 * 0.014*5;
											gravity1 = new THREE.Vector3( 0, - GRAVITY1, 0 ).multiplyScalar( MASS );
											object.position.z+=1;
										}
										break;
								default:
							}
						
							//lowest
							//object.scale.set(4,3.5,4);//highest
							//object.position.set(25,-44,1);//
		//					object.scale.set(3.4,3.4,3.4);
							//object.position.set(21,-44,1);//
//							var why = -44;
//							var diffEnota2 = 41.0/66.0;
	//						var hightValue = measurement_sliders[0].slider( "value");	
	//						why+=(hightValue-148)*diffEnota2;
//							vsota = measurement_sliders[5].slider( "value")
						//	vsota = measurement_sliders[0].slider( "value")+	
						//	measurement_sliders[1].slider( "value")+	
						//	measurement_sliders[2].slider( "value")+	
						//	measurement_sliders[3].slider( "value")+	
						//	measurement_sliders[4].slider( "value");
//							console.log(vsota);
//							if(vsota > 80)
//								why+=5;
							//object.position.set(21,-3,1);
//							console.log(why);
//							object.position.set(21,why,1);
//							material = 4;
					//		console.log(buff);
					//		console.log(object);
							//object.children[0].geometry
							oblacilo1=object;
							oblacilo1.updateMatrixWorld();
							clothWorldMaths.push(oblacilo1.matrixWorld);
							clothWorldMathsInverses.push(new THREE.Matrix4().getInverse(oblacilo1.matrixWorld));
							if(clothIndex2 > 0){
								scene2.add( object );
							}else{
								scene.add(object);
								scene2 = null;
							}
							//scene.add( object );
							//console.log(object.geometry);
							//inseam 80 max

						});

					});
				}
				else{
					clothWorldMaths.push([]);
					clothWorldMathsInverses.push([]);
				}
				setTimeout(function(){
						if(clothIndex2 > 0){
							var r = parseInt(document.getElementById("rpcolor").value) /255.0;
							var g = parseInt(document.getElementById("gpcolor").value)/255.0;
							var b = parseInt(document.getElementById("bpcolor").value)/255.0;
							var colorSet = false;
							if(!isNaN(r) && !isNaN(g) && !isNaN(b)){
								if(r >= 0  && r <= 1 && g >= 0 && g <= 1 && b >= 0 && b <= 1){
									colorSet = true
								}
							}
							if(document.getElementById("pStiff").selected){
								pantsStiffness = 1;
							}else{
								pantsStiffness = 2;
							}
							GRAVITY2 = 981 * 0.0014;
							gravity2 = new THREE.Vector3( 0, - GRAVITY2, 0 ).multiplyScalar( MASS );
							var tex = new THREE.Texture();
							THREE.Loader.Handlers.add( /\.dds$/i, new THREE.DDSLoader() );
							var mtlLoader = new THREE.MTLLoader();
							mtlLoader.setPath( 'three.js-master/examples/obj/clothes/pants/customTexture/' );
							mtlLoader.load( 'hlace.mtl', function( materials ) {
							materials.preload();
							
								var objLoader2 = new THREE.OBJLoader();
								objLoader2.setMaterials( materials );
								objLoader2.setPath( 'three.js-master/examples/obj/clothes/pants/customTexture/' );
								objLoader2.load( 'hlace.obj', function ( object2 ) {
									if(colorSet){
										materials.materials.jeans.color.r=r;
										materials.materials.jeans.color.g=g;
										materials.materials.jeans.color.b=b;
									}

									object2.position.set(0,-70,0);
									//object2.scale.set(78,92,78);
									//ZACETEK INSEAM MERITEV
									//#1
									//object2.scale.set(78,60,78);//lowest inseam at lowest hight
									//#2
									//object2.scale.set(78,75,78);//highest inseam
						/*			var why = 60;
									var diffEnota = 15.0/44.0; maybe go with 16
									var inseamValue = measurement_sliders[5].slider( "value");
									
									why+=(inseamValue-60)*diffEnota;
									object2.scale.set(78,why,78);*/
									//#3
									//min inseam max hight, lowest inseam max hight= highest inseam, min hight
									//object2.scale.set(78,75,78);
									//#4
									//highest inseam max hight
									//object2.scale.set(78,92,78);
									//object2.scale.set(78,76,78);
									var why = 60;
									var diffEnota = 16.0/44.0;// maybe go with 16
									var inseamValue = measurement_sliders[5].slider( "value");			
									why+=(inseamValue-60)*diffEnota;
									var diffEnota2 = 16.0/66.0;
									var hightValue = measurement_sliders[0].slider( "value");	
									why+=(hightValue-148)*diffEnota2;
									//object2.scale.set(78,why,78);
									//object2.scale.set(78,why,78);//starting values
									//object2.scale.set(90,why,90); //max waist
									//object2.scale.set(73,why,73);//74 75 69 //73 z 69 x happy medium
									
									// min hips exploration
									//object2.scale.set(55,why,73);
									//max hips 
								//	object2.scale.set(83,why,73);
												//final max hip object2.scale.set(83,why,83);
								//	object2.scale.set(86,why,73);
								//	object2.scale.set(105,why,73);
								//	object2.scale.set(100,why,73);
									var hip = 55; hipZ = 73;
									var diffEnota = 28.0/65.0;
									var hipValue = measurement_sliders[4].slider( "value");	
									hip+=(hipValue-74)*diffEnota;
									var diffEnota2 = 10.0/65.0;
									hipZ+=(hipValue-74)*diffEnota2;
									var weight = measurement_sliders[1].slider( "value");	
									if(weight > 95){
										hip+=10;
									}
									object2.scale.set(hip,why,hip);
									oblacilo2=object2;
									oblacilo2.updateMatrixWorld();
									clothWorldMaths.push(oblacilo2.matrixWorld);
									clothWorldMathsInverses.push(new THREE.Matrix4().getInverse(oblacilo2.matrixWorld));
									scene.add( object2 );
									//console.log(object2.geometry);

								});

							});
						}//else{
						//	clothWorldMaths.push([]);
						//	clothWorldMathsInverses.push([]);
						//}
				}, 25);
			}
			
			function setUpClothSimulation(){
				if(oblacilo1 != null){
					cloth = new Cloth(oblacilo1,0 );
					// cloth geometry
					clothGeometry = oblacilo1.children[0].geometry;
					clothGeometry.dynamic = true;
				}
				if(oblacilo2 != null){
					cloth2 = new Cloth(oblacilo2,1 );
					clothGeometry2 = oblacilo2.children[0].geometry;
					clothGeometry2.dynamic = true;
				}
			}
			
			function init(clothPaint) {
				var container=document.getElementById("three");

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
				camera.position.z = 250;
				//camera.position.z = 500;
				//camera.position.z = 1000;

				// scene

				var ambient = new THREE.AmbientLight( 0x101030 );
				scene.add( ambient );
				if(scene2 != null){
					var ambient2 = new THREE.AmbientLight( 0x101030 );
					scene2.add(ambient2);
				}
				var directionalLight = new THREE.DirectionalLight( 0xffeedd,0.7 );
				//directionalLight.position.set( 0, 0, 1 );
				directionalLight.position.set( 0, 0, 1 );
				scene.add( directionalLight );
				var d2 = new THREE.DirectionalLight( 0xffeedd,0.6 );
				d2.position.set( 0.41, 0.82, 0.41 );
				scene.add( d2 );
				var directionalLight3 = new THREE.DirectionalLight( 0xffeedd,0.7 );
				//directionalLight.position.set( 0, 0, 1 );
				directionalLight3.position.set( 0, 0, -1 );
				scene.add( directionalLight3 );
				if(scene2 != null){
					var directionalLight222 = new THREE.DirectionalLight( 0xffeedd,0.7 );
					directionalLight222.position.set( 0, 0, 1 );
					var d222 = new THREE.DirectionalLight( 0xffeedd,0.6 );
					d222.position.set( 0.41, 0.82, 0.41 );
					var directionalLight322 = new THREE.DirectionalLight( 0xffeedd,0.7 );
					directionalLight322.position.set( 0, 0, -1 );
					scene2.add(directionalLight222);
					scene2.add(d222);
					scene2.add(directionalLight322);
				}
				// model
				
				geometry = new THREE.BufferGeometry();
				positions = templateVerticesMale.slice();
				normals = templateNormalsMale.slice();
				indices = templateIndicesMale;
				sf = scaleFactors;

				var meanScaleFactor = 0.0;var stevec = 0;
					for(var j = 0; j < sf.length;j++){
						meanScaleFactor += sf[j];
						//rokmadroksmash.push(sf[j]);
						stevec++;
					}
				//console.log(sf);
				var mean = 1.0-meanScaleFactor;
				
				for(i = 0; i < positions.length;i++){
					positions[i]*=mean;
				}

				for(var k = 0; k < 7;k++){
					var p1 = offsetVerticesMale[k];
					var n1 = offsetNormalsMale[k];
					for(i = 0;i < p1.length;i++){
						positions[i]+=p1[i]*sf[k];
						normals[i]+=n1[i]*sf[k];
					}	
				}
				//delete p1;
				//delete n1;
				
				
				geometry.addAttribute( 'position', new THREE.BufferAttribute( positions, 3 ) );
				geometry.addAttribute( 'normal', new THREE.BufferAttribute( normals, 3 ) );
				geometry.setIndex( new THREE.BufferAttribute( indices, 1 ) );
				geometry.computeBoundingBox();
				
				mesh = new THREE.Mesh(geometry,new THREE.MeshLambertMaterial( { color: 0x90BCF9}));
				//mesh = new THREE.Mesh(geometry,new THREE.MeshLambertMaterial( { color: 0x7D97E5,vertexColor: THREE.VertexColors }));
				mesh.scale.set(70,70,70);
				mesh.position.set(0,-70,0);
				mesh.updateMatrixWorld();
				var matix = mesh.matrixWorld;
				geometry.boundingBox.applyMatrix4(matix);
				scene.add(mesh);
				
				//var helper = new THREE.VertexNormalsHelper( mesh, 2, 0x00ff00, 1 );
				//scene.add(helper);


				//console.log(geometry.boundingBox);
				if(clothPaint && boxesList.length == 0){
					var geoL = new THREE.Geometry();
					geoL.vertices=[];
					geoL.vertices.push(geometry.boundingBox.min);
					geoL.vertices.push(geometry.boundingBox.max);
					var origBox = geometry.boundingBox;
					var max = new THREE.Vector3().copy(origBox.max);
					var min = new THREE.Vector3().copy(origBox.min);
					var differ = (max.y - min.y)/15.0;
					sirinaSkatelj = differ;
					var max2= new THREE.Vector3().copy(max);
				/*	console.log("orig max");
					console.log(max);
					console.log("orig min");
					console.log(min);
					console.log(differ);*/
					for(var steve = 0; steve<15;steve++){
							var min2 = new THREE.Vector3().copy(min);
							min2.y+=differ*(14-steve);
			//				boxesList.push(new THREE.Box3(min2,max2));
			//				max2= new THREE.Vector3().copy(max);
			//				max2.y-=differ*(steve+1);
						var startX = min2.x;var startX2 = max2.x;
						var steviloSkatelj = 3;//stevilo vodoravnih boxov
						var differ2 = Math.abs(startX-startX2)/steviloSkatelj;
						for(var steve2 = 0; steve2 < steviloSkatelj; steve2++){
							var min3 = new THREE.Vector3().copy(min2);
							min3.x += differ2*steve2;
							max2 = new THREE.Vector3().copy(max2);
							max2.x = min2.x+(differ2*(steve2+1));
							boxesList.push(new THREE.Box3(min3,max2));	
						}
						//boxesList.push(new THREE.Box3(min2,max2));//tole se zakomentira ce delas z notranjimi boxi
						max2= new THREE.Vector3().copy(max);
						max2.y-=differ*(steve+1);
					}
					var bodyArray = geometry.getAttribute('position').array;
					var normalArray = geometry.getAttribute('normal').array;
					
					var normalMatrix = new THREE.Matrix3();
					normalMatrix.getNormalMatrix(mesh.matrixWorld);			
					for(var i = 0; i < boxesList.length;i++){
						boxesPoints.push([]);
						boxesNormals.push([]);
						for(var j=0;j < bodyArray.length;j=j+3){
							var pointek = new THREE.Vector3(bodyArray[j],bodyArray[j+1],bodyArray[j+2]);
							pointek.applyMatrix4(matix);
							//if(boxesList[i].containsPoint(pointek));{
								//console.log("wtf");
							//	boxesPoints[i].push(pointek);
							//}
							if(pointek.x <= boxesList[i].max.x && pointek.x >= boxesList[i].min.x)
							{
								if(pointek.y <= boxesList[i].max.y && pointek.y >= boxesList[i].min.y){
									if(pointek.z <= boxesList[i].max.z && pointek.z >= boxesList[i].min.z){
										
										boxesPoints[i].push(pointek);
										var normalP = new THREE.Vector3(normalArray[j],normalArray[j+1],normalArray[j+2]);
										normalP.applyMatrix3( normalMatrix ).normalize().add( pointek );
										boxesNormals[i].push(normalP);
									}
								}
							}
						}
					}
				}
				delete bodyArray; delete normalArray;  
			/*	for(var ij = 0; ij < boxesList.length;ij++){
					var linija = new THREE.Geometry();
					linija.vertices=[];
					linija.vertices.push(boxesList[ij].min);
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].min.x,boxesList[ij].min.y,boxesList[ij].max.z));
					linija.vertices.push(boxesList[ij].max);
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].min.x,boxesList[ij].max.y,boxesList[ij].min.z));
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].min.x,boxesList[ij].max.y,boxesList[ij].max.z));
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].max.x,boxesList[ij].max.y,boxesList[ij].min.z));
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].max.x,boxesList[ij].min.y,boxesList[ij].max.z));
					//linija.vertices.push(new THREE.Vector3(boxesList[ij].max.x,boxesList[ij].min.y,boxesList[ij].min.z));

					var obLinija = new THREE.Line(linija,new THREE.LineBasicMaterial({color: 0xff0000}));
					scene.add(obLinija);
				}*/
				if(prvoRisanje){
					renderer = new THREE.WebGLRenderer();
					renderer.setPixelRatio( window.devicePixelRatio );
					renderer.setSize( window.innerWidth/1.5, window.innerHeight/1.5 );
					container.appendChild( renderer.domElement );
					rend = renderer;
					prvoRisanje = false;
					renderer.autoClear=false;
				}
				// controls
					var controls = new THREE.OrbitControls( camera, rend.domElement );
					controls.maxPolarAngle = Math.PI * 0.5;
					controls.minDistance = 100;
					controls.maxDistance = 500;
				
				window.addEventListener( 'resize', onWindowResize, false );
			}

			function onWindowResize() {

				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}


			//

			function animate() {
			//console.time('someFunction');
				//console.log(stevecLUL);
				//console.log(prejsniStevec);
				if(stevecLUL > prejsniStevec){
					//console.log("umm");
					prejsniStevec=stevecLUL;
					return;
				}
				requestAnimationFrame( animate );
				var time = Date.now();
				//windStrength = Math.cos( time / 7000 ) * 20 + 40;
				//windForce.set( Math.sin( time / 2000 ), Math.cos( time / 3000 ), Math.sin( time / 1000 ) ).normalize().multiplyScalar( windStrength );
				if(cloth != null || cloth2 != null){
					simulate( time );
				}
				render();
				//console.timeEnd('someFunction');
				
			}
			
			
			function render() {

				//camera.position.x += ( mouseX - camera.position.x ) * .05;
				//camera.position.y += ( - mouseY - camera.position.y ) * .05;
				camera.lookAt( scene.position );
				if(cloth!=null){
					var p = cloth.particles;
					var ver = clothGeometry.getAttribute('position').array;
					for ( var i = 0, il = p.length; i < il; i ++ ) {
						var kopija = new THREE.Vector3().copy(p[i].position).applyMatrix4(clothWorldMathsInverses[0]);
						ver[i*3]=kopija.x;
						ver[i*3+1]=kopija.y;
						ver[i*3+2]=kopija.z;
					}
					clothGeometry.attributes.position.needsUpdate = true;
					clothGeometry.computeFaceNormals();
					//clothGeometry.computeVertexNormals();
					clothGeometry.attributes.normal.needsUpdate = true;
				}
				if(cloth2 != null){
					var p2222 = cloth2.particles;
					var ver2222 = clothGeometry2.getAttribute('position').array;
					for ( var i = 0, il = p2222.length; i < il; i ++ ) {
						var kopija2222 = new THREE.Vector3().copy(p2222[i].position).applyMatrix4(clothWorldMathsInverses[1]);
						ver2222[i*3]=kopija2222.x;
						ver2222[i*3+1]=kopija2222.y;
						ver2222[i*3+2]=kopija2222.z;
					}
					clothGeometry2.attributes.position.needsUpdate = true;
					clothGeometry2.computeFaceNormals();
					//clothGeometry2.computeVertexNormals();
					clothGeometry2.attributes.normal.needsUpdate = true;
				}
				renderer.clear();
				renderer.render( scene, camera );
				renderer.clearDepth();
				if(scene2 != null)
					renderer.render(scene2,camera);
				

			}
	}
		/*	function onDocumentMouseMove( event ) {
				if(mouseDown){
					mouseX = ( event.clientX - windowHalfX ) / 2;
					mouseY = ( event.clientY - windowHalfY ) / 2;
				}

			}
			function onDocumentMouseDown( event ) {
				mouseDown=true;
			}
			function onDocumentMouseUp( event ) {
				mouseDown=false;
			}*/

	</script>
</head>
<body onpageshow="skrij()">
		<div id="sliderTry">
						<div id="sliders-column">
					<div id="slider-row-template" style="display:none;">
						<div class="slider-row" id="_string1_-slider-row">
							<div class="slider-label-div" id="_string1_-label-div">
								<span class="slider-label" id="_string1_-slider-label">_string2_: </span>
							</div>
							<div class="slider-value-div" id="_string1_-slider-value-div">
								<span class="slider-value" id="_string1_-slider-value">&nbsp;</span>
							</div>
							<div class="slider-units-div" id="_string1_-slider-units-div">
								<span class="slider-units" id="_string1_-slider-units">inches</span>
								<span class="slider-status" id="_string1_-slider-status"></span>
								<span class="slider-instructions" id="_string1_-slider-instructions">
									<a href="#" onClick='show_instructions("_string2_"); return false;'>(?)</a>
								</span>
							</div>
							<div class="measurement-slider" id="_string1_-measurement-slider"></div>
						</div>
					</div>
					<button id="resetButton" onclick="reset_all_sliders(6)">Reset all sliders</button>
					<button id="switchUnits" onClick="toggle_units(); return false;">Switch slider units</button>	
				</div>
					<div id="sliders" style></div>
					<script>
						parent_element = $('sliders');
						template_element = $('slider-row-template');
						for (var i = 0; i < names.length; i++) {
							addElementFromTemplate(parent_element, template_element, ['_string1_','_string2_'], [names[i].toLowerCase(), names[i]]);
						}
						$J('#age-slider-units').html('years');
						$J('#weight-slider-units').html('pounds');
						$J('#exercise-slider-units').html('hours/week');
						measurement_slider_divs = $J('#sliders .measurement-slider');
						//console.log("meritev"+measurement_slider_divs);
						//wsetupSliders();
						setupSliders();
						for (var i = 0; i < 7; i++) {
							measurement_sliders[i].slider( "option", "disabled", false );
						}
						

					</script>
					

			
		<div id="popup" style="display: none;">
			<div id="popup_header"><a href="#" onClick="$J('#popup').hide(); return false;">CLOSE X</a></div>
			<div id="popup_content"></div>
		</div>
		

		</div>
		<div id="three"></div>
					<script>start(false);</script>

</body>
</html>